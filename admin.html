<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --white: #ffffff;
      --off-white: #f5f5f7;
      --light-gray: #e8e8ed;
      --mid-gray: #86868b;
      --dark: #1d1d1f;
      --danger: #d63031;
      --sidebar-w: 240px;
      --radius: 16px;
      --radius-sm: 12px;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--dark);
      background: var(--off-white);
      -webkit-font-smoothing: antialiased;
      display: flex;
      min-height: 100vh;
    }

    /* ── Sidebar ── */

    .sidebar {
      width: var(--sidebar-w);
      background: var(--white);
      border-right: 1px solid var(--light-gray);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      bottom: 0;
      overflow-y: auto;
    }

    .sidebar-logo {
      font-size: 1rem;
      font-weight: 600;
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--light-gray);
      letter-spacing: -0.02em;
    }

    .sidebar-nav {
      padding: 16px 12px;
      flex: 1;
    }

    .sidebar-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    /* ── Top-level link (Dashboard) ── */
    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 0.8125rem;
      color: var(--mid-gray);
      text-decoration: none;
      border-radius: var(--radius-sm);
      transition: background 0.2s, color 0.2s;
      cursor: pointer;
    }

    .sidebar-link:hover {
      background: var(--off-white);
      color: var(--dark);
    }

    .sidebar-link.active {
      color: #3b82f6;
      font-weight: 500;
    }

    /* ── Accordion group ── */
    .sidebar-group {
      margin-top: 4px;
    }

    .sidebar-group-header {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 16px;
      font-size: 0.8125rem;
      font-weight: 500;
      font-family: inherit;
      color: var(--mid-gray);
      background: none;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      text-align: left;
    }

    .sidebar-group-header:hover {
      background: var(--off-white);
      color: var(--dark);
    }

    .sidebar-chevron {
      width: 14px;
      height: 14px;
      margin-left: auto;
      flex-shrink: 0;
      transition: transform 0.3s cubic-bezier(0.15, 0.83, 0.66, 1);
    }

    .sidebar-group.open .sidebar-chevron {
      transform: rotate(180deg);
    }

    .sidebar-group.open .sidebar-group-header {
      color: var(--dark);
      background: rgba(59, 130, 246, 0.06);
      backdrop-filter: blur(8px);
    }

    .sidebar-group-items {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.35s cubic-bezier(0.15, 0.83, 0.66, 1),
                  opacity 0.3s ease;
    }

    .sidebar-group.open .sidebar-group-items {
      max-height: 300px;
      opacity: 1;
    }

    .sidebar-group-items .sidebar-link {
      padding: 8px 16px 8px 44px;
      font-size: 0.8125rem;
      font-weight: 400;
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--light-gray);
      font-size: 0.75rem;
      color: var(--mid-gray);
    }

    .sidebar-footer a {
      color: var(--mid-gray);
      text-decoration: none;
    }

    .sidebar-footer a:hover {
      color: var(--dark);
    }

    /* ── Main content ── */

    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      padding: 40px;
    }

    .main h1 {
      font-size: 1.75rem;
      font-weight: 600;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
    }

    .main .subtitle {
      font-size: 0.9375rem;
      color: var(--mid-gray);
      margin-bottom: 40px;
    }

    /* ── Panels / Sections ── */

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* ── Stat cards ── */

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 28px 24px;
    }

    .stat-card .label {
      font-size: 0.8125rem;
      color: var(--mid-gray);
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: -0.03em;
    }

    /* ── Insight Cards ── */

    .insight-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: saturate(140%) blur(16px);
      -webkit-backdrop-filter: saturate(140%) blur(16px);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .velocity-chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 140px;
    }

    .velocity-bar-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      height: 100%;
      justify-content: flex-end;
    }

    .velocity-bar {
      width: 100%;
      max-width: 48px;
      border-radius: 6px 6px 2px 2px;
      background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%);
      min-height: 2px;
      transition: height 0.5s cubic-bezier(0.15, 0.83, 0.66, 1);
    }

    .velocity-count {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--dark);
    }

    .velocity-label {
      font-size: 0.625rem;
      color: var(--mid-gray);
      text-align: center;
    }

    .top-interest-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .interest-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: var(--off-white);
      border-radius: var(--radius-sm);
    }

    .interest-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #3b82f6;
      color: #fff;
      font-size: 0.6875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .interest-label {
      flex: 1;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .interest-count {
      font-size: 0.8125rem;
      color: var(--mid-gray);
      font-weight: 500;
    }

    .lang-legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lang-legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8125rem;
    }

    .lang-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ── Table ── */

    .panel {
      background: var(--white);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 24px;
    }

    .panel h2 {
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 20px;
    }

    .panel table {
      width: 100%;
      border-collapse: collapse;
    }

    .panel th,
    .panel td {
      text-align: left;
      padding: 12px 0;
      font-size: 0.875rem;
      border-bottom: 1px solid var(--light-gray);
    }

    .panel th {
      color: var(--mid-gray);
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 980px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge.published {
      background: #e8f5e2;
      color: #2a7d2e;
    }

    .badge.draft {
      background: var(--light-gray);
      color: var(--mid-gray);
    }

    .badge.nav-badge {
      background: #e0ecff;
      color: #1a56db;
    }

    .badge.category-badge {
      background: #f0e6ff;
      color: #7c3aed;
    }

    .badge.footer-badge {
      background: #fef3e2;
      color: #b45309;
    }

    /* ── Forms ── */

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--mid-gray);
      margin-bottom: 8px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .form-group select,
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="color"] {
      width: 100%;
      padding: 10px 14px;
      font-size: 0.9375rem;
      font-family: inherit;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      background: var(--white);
      color: var(--dark);
      transition: border-color 0.2s;
    }

    .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      font-size: 0.9375rem;
      font-family: inherit;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      background: var(--white);
      color: var(--dark);
      resize: vertical;
      min-height: 160px;
      line-height: 1.6;
      transition: border-color 0.2s;
    }

    .form-group select:focus,
    .form-group input[type="text"]:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--mid-gray);
    }

    .form-group input[type="color"] {
      height: 44px;
      padding: 4px 6px;
      cursor: pointer;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .checkbox-row {
      display: flex;
      gap: 28px;
      margin-bottom: 24px;
    }

    .checkbox-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      color: var(--dark);
      cursor: pointer;
      text-transform: none;
      letter-spacing: 0;
      font-weight: 400;
    }

    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--dark);
      cursor: pointer;
    }

    /* ── Buttons ── */

    .btn {
      display: inline-block;
      padding: 10px 24px;
      font-size: 0.875rem;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: 980px;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .btn:hover {
      transform: scale(0.97);
    }

    .btn:active {
      transform: scale(0.94);
    }

    .btn-primary {
      color: var(--white);
      background: var(--dark);
    }

    .btn-primary:hover {
      background: #000;
    }

    .btn-secondary {
      color: var(--dark);
      background: var(--off-white);
      border: 1px solid var(--light-gray);
    }

    .btn-danger {
      color: var(--white);
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #b71c1c;
    }

    .btn-sm {
      padding: 6px 16px;
      font-size: 0.8125rem;
    }

    .btn-save {
      display: inline-block;
      padding: 12px 28px;
      font-size: 0.9375rem;
      font-weight: 500;
      font-family: inherit;
      color: var(--white);
      background: var(--dark);
      border: none;
      border-radius: 980px;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .btn-save:hover {
      background: #000;
      transform: scale(0.97);
    }

    .btn-save:active {
      transform: scale(0.94);
    }

    /* ── Page list ── */

    .page-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .page-list-header h2 {
      margin-bottom: 0;
    }

    .page-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid var(--light-gray);
    }

    .page-row:last-child {
      border-bottom: none;
    }

    .page-row-info {
      flex: 1;
      min-width: 0;
    }

    .page-row-title {
      font-size: 0.9375rem;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .page-row-slug {
      font-size: 0.8125rem;
      color: var(--mid-gray);
    }

    .page-row-badges {
      display: flex;
      gap: 6px;
      margin-left: 16px;
      flex-shrink: 0;
    }

    .page-row-actions {
      display: flex;
      gap: 8px;
      margin-left: 16px;
      flex-shrink: 0;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--mid-gray);
      font-size: 0.9375rem;
    }

    /* ── Page form panel ── */

    .page-form-panel {
      display: none;
    }

    .page-form-panel.visible {
      display: block;
    }

    /* ── Toast ── */

    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: var(--dark);
      color: var(--white);
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      z-index: 200;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ── Live preview ── */

    .preview-frame {
      width: 100%;
      height: 400px;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius);
      margin-top: 24px;
    }

    /* ── Homepage Layout tiles ── */

    .tile-editor {
      background: var(--off-white);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 20px;
    }

    .tile-editor h3 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 16px;
      letter-spacing: -0.01em;
    }

    .tile-editor .form-group {
      margin-bottom: 16px;
    }

    .tile-editor .form-group:last-child {
      margin-bottom: 0;
    }

    .tile-editor textarea {
      min-height: 100px;
    }

    /* ── Media Library ── */

    .media-form {
      display: none;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--off-white);
      border-radius: var(--radius-sm);
    }

    .media-form.visible {
      display: block;
    }

    .media-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--light-gray);
    }

    .media-row:last-child {
      border-bottom: none;
    }

    .media-thumb {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 8px;
      background: var(--light-gray);
      flex-shrink: 0;
    }

    .media-info {
      flex: 1;
      min-width: 0;
    }

    .media-label {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .media-url {
      font-size: 0.8125rem;
      color: var(--mid-gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 360px;
    }

    .media-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    /* ── GitHub Upload & Media Grid ── */

    .media-drop-zone {
      border: 2px dashed var(--light-gray);
      border-radius: var(--radius);
      padding: 40px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
      margin-bottom: 24px;
      position: relative;
    }

    .media-drop-zone:hover,
    .media-drop-zone.drag-over {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.04);
    }

    .media-drop-zone.uploading {
      pointer-events: none;
      opacity: 0.6;
    }

    .media-drop-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .media-drop-text {
      font-size: 0.9375rem;
      color: var(--mid-gray);
      margin-bottom: 4px;
    }

    .media-drop-hint {
      font-size: 0.75rem;
      color: var(--mid-gray);
      opacity: 0.7;
    }

    .media-drop-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .media-progress {
      margin-top: 12px;
      display: none;
    }

    .media-progress.visible {
      display: block;
    }

    .media-progress-bar {
      height: 4px;
      background: var(--light-gray);
      border-radius: 2px;
      overflow: hidden;
    }

    .media-progress-fill {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .media-progress-text {
      font-size: 0.75rem;
      color: var(--mid-gray);
      margin-top: 6px;
      text-align: center;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }

    .media-grid-item {
      position: relative;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--light-gray);
      aspect-ratio: 1;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .media-grid-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .media-grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .media-grid-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,0.65) 100%);
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 10px;
    }

    .media-grid-item:hover .media-grid-overlay {
      opacity: 1;
    }

    .media-grid-label {
      font-size: 0.6875rem;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }

    .media-grid-actions {
      display: flex;
      gap: 4px;
    }

    .media-grid-actions button {
      flex: 1;
      padding: 4px 0;
      font-size: 0.625rem;
      font-weight: 500;
      font-family: inherit;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .media-grid-actions .mgrid-copy {
      background: rgba(255,255,255,0.85);
      color: var(--dark);
    }

    .media-grid-actions .mgrid-copy:hover {
      background: #fff;
    }

    .media-grid-actions .mgrid-delete {
      background: rgba(214, 48, 49, 0.85);
      color: #fff;
    }

    .media-grid-actions .mgrid-delete:hover {
      background: #d63031;
    }

    /* ── GitHub PAT Modal ── */

    .gh-pat-overlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .gh-pat-modal {
      background: var(--white);
      border-radius: var(--radius);
      padding: 32px;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 16px 60px rgba(0,0,0,0.15);
    }

    .gh-pat-modal h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .gh-pat-modal p {
      font-size: 0.8125rem;
      color: var(--mid-gray);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .gh-pat-modal input {
      width: 100%;
      padding: 10px 14px;
      font-size: 0.875rem;
      font-family: monospace;
      border: 1px solid var(--light-gray);
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
    }

    .gh-pat-modal input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .gh-pat-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* ── Media Picker Modal ── */

    .media-picker-overlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .media-picker-modal {
      background: var(--white);
      border-radius: var(--radius);
      width: 90%;
      max-width: 640px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 16px 60px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .media-picker-header {
      padding: 20px 24px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--light-gray);
    }

    .media-picker-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .media-picker-close {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: var(--off-white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: var(--mid-gray);
      transition: background 0.15s ease;
    }

    .media-picker-close:hover {
      background: var(--light-gray);
    }

    .media-picker-body {
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
    }

    .media-picker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 12px;
    }

    .media-picker-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.15s ease, transform 0.15s ease;
    }

    .media-picker-item:hover {
      border-color: #3b82f6;
      transform: scale(1.03);
    }

    .media-picker-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .media-picker-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--mid-gray);
      font-size: 0.875rem;
    }

    /* ── Browse button inline ── */

    .browse-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
      font-family: inherit;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      background: var(--white);
      color: var(--mid-gray);
      cursor: pointer;
      transition: border-color 0.15s ease, color 0.15s ease;
      margin-left: 8px;
      vertical-align: middle;
    }

    .browse-btn:hover {
      border-color: #3b82f6;
      color: var(--dark);
    }

    /* ── Education Picklist Cards ── */

    .edu-cards-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .edu-card {
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.8);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    }

    .edu-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .edu-card-header h2 {
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0;
      color: var(--dark);
    }

    .edu-card-header .edu-card-count {
      font-size: 0.8rem;
      color: var(--mid-gray);
      background: var(--light-gray);
      padding: 2px 10px;
      border-radius: 12px;
    }

    .edu-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      background: var(--white);
      margin-bottom: 8px;
      border: 1px solid var(--light-gray);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .edu-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59,130,246,0.10);
    }

    .edu-item-label {
      flex: 1;
      font-size: 0.925rem;
      font-weight: 500;
      color: var(--dark);
    }

    .edu-item-actions {
      display: flex;
      gap: 4px;
      opacity: 0.4;
      transition: opacity 0.15s ease;
    }

    .edu-item:hover .edu-item-actions {
      opacity: 1;
    }

    .edu-icon-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--mid-gray);
      transition: background 0.15s ease, color 0.15s ease;
    }

    .edu-icon-btn:hover {
      background: var(--light-gray);
      color: var(--dark);
    }

    .edu-icon-btn.danger:hover {
      background: #fef2f2;
      color: #ef4444;
    }

    .edu-add-btn {
      width: 100%;
      padding: 10px;
      border: 2px dashed #3b82f6;
      background: rgba(59,130,246,0.04);
      color: #3b82f6;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s ease;
      margin-top: 4px;
    }

    .edu-add-btn:hover {
      background: rgba(59,130,246,0.10);
    }

    .edu-inline-form {
      background: var(--white);
      border: 2px solid #3b82f6;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .edu-inline-form input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .edu-inline-form .btn {
      flex-shrink: 0;
    }

    /* ── Logic Map ── */

    .logic-map-section {
      margin-top: 8px;
    }

    .logic-map-section h2 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .logic-map-section .subtitle {
      margin-bottom: 20px;
    }

    .logic-map-grid {
      display: grid;
      gap: 16px;
    }

    .logic-map-group {
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.8);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    }

    .logic-map-group-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--light-gray);
    }

    .logic-map-goal {
      margin-bottom: 16px;
      padding: 16px;
      background: var(--white);
      border: 1px solid var(--light-gray);
      border-radius: 10px;
    }

    .logic-map-goal:last-child {
      margin-bottom: 0;
    }

    .logic-map-goal-label {
      font-size: 0.925rem;
      font-weight: 600;
      color: #3b82f6;
      margin-bottom: 12px;
    }

    .logic-map-field {
      margin-bottom: 10px;
    }

    .logic-map-field:last-child {
      margin-bottom: 0;
    }

    .logic-map-field label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--mid-gray);
      margin-bottom: 4px;
    }

    .logic-map-field input,
    .logic-map-field textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      font-size: 0.875rem;
      transition: border-color 0.15s ease;
    }

    .logic-map-field input:focus,
    .logic-map-field textarea:focus {
      border-color: #3b82f6;
      outline: none;
    }

    .logic-map-field textarea {
      min-height: 60px;
      resize: vertical;
    }

    .logic-map-field .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .logic-map-save-row {
      margin-top: 20px;
      text-align: right;
    }

    /* ── Responsive ── */

    @media (max-width: 768px) {
      .sidebar {
        width: 56px;
        --sidebar-w: 56px;
      }
      .sidebar-logo,
      .sidebar-footer {
        display: none;
      }
      .sidebar-nav {
        padding: 12px 8px;
      }
      .sidebar-link span,
      .sidebar-group-header span,
      .sidebar-chevron,
      .sidebar-group-items {
        display: none !important;
      }
      .sidebar-link,
      .sidebar-group-header {
        justify-content: center;
        padding: 12px;
        gap: 0;
      }
      .sidebar-group-header {
        pointer-events: none;
      }
      .sidebar-group.open .sidebar-group-header {
        background: none;
      }
      .main {
        margin-left: 56px;
        padding: 24px;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .page-row {
        flex-wrap: wrap;
        gap: 8px;
      }
      .page-row-badges {
        margin-left: 0;
      }
      .page-row-actions {
        margin-left: 0;
      }
      .media-url {
        max-width: 140px;
      }
      .edu-cards-row {
        grid-template-columns: 1fr;
      }
      .logic-map-field .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-logo">Admin</div>
    <nav class="sidebar-nav">
      <a class="sidebar-link active" data-section="dashboard">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        <span>Dashboard</span>
      </a>

      <div class="sidebar-group" data-group="content">
        <button class="sidebar-group-header">
          <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span>Content Management</span>
          <svg class="sidebar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="sidebar-group-items">
          <a class="sidebar-link" data-section="homepage"><span>Homepage Layout</span></a>
          <a class="sidebar-link" data-section="trustproof"><span>Trust & Social Proof</span></a>
          <a class="sidebar-link" data-section="pages"><span>Pages</span></a>
          <a class="sidebar-link" data-section="posts"><span>Posts</span></a>
          <a class="sidebar-link" data-section="media"><span>Media</span></a>
        </div>
      </div>

      <div class="sidebar-group" data-group="team">
        <button class="sidebar-group-header">
          <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <span>The Team</span>
          <svg class="sidebar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="sidebar-group-items">
          <a class="sidebar-link" data-section="staff"><span>Staff</span></a>
          <a class="sidebar-link" data-section="testimonials"><span>Testimonials</span></a>
        </div>
      </div>

      <div class="sidebar-group" data-group="operations">
        <button class="sidebar-group-header">
          <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span>Firm Operations</span>
          <svg class="sidebar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="sidebar-group-items">
          <a class="sidebar-link" data-section="officelocations"><span>Office Locations</span></a>
          <a class="sidebar-link" data-section="locations"><span>Locations Pages</span></a>
          <a class="sidebar-link" data-section="businesshours"><span>Business Hours</span></a>
          <a class="sidebar-link" data-section="education"><span>Education Logic</span></a>
        </div>
      </div>

      <div class="sidebar-group" data-group="insights">
        <button class="sidebar-group-header">
          <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          <span>Insights</span>
          <svg class="sidebar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="sidebar-group-items">
          <a class="sidebar-link" data-section="analytics"><span>Analytics</span></a>
        </div>
      </div>

      <div class="sidebar-group" data-group="system">
        <button class="sidebar-group-header">
          <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          <span>System Settings</span>
          <svg class="sidebar-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="sidebar-group-items">
          <a class="sidebar-link" data-section="settings"><span>Site Settings</span></a>
          <a class="sidebar-link" data-section="navfooter"><span>Navigation & Footer</span></a>
          <a class="sidebar-link" data-section="contactconfig"><span>Contact Config</span></a>
          <a class="sidebar-link" data-section="clocksettings"><span>Clock Settings</span></a>
          <a class="sidebar-link" data-section="translation"><span>Translation</span></a>
          <a class="sidebar-link" data-section="salesforcebox"><span>Salesforce & Box</span></a>
        </div>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a href="index.html">&larr; Back to site</a>
    </div>
  </aside>

  <div class="main">

    <!-- ── Dashboard ── -->
    <div id="dashboard" class="section active">
      <h1>Dashboard</h1>
      <p class="subtitle">Overview of your site activity.</p>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Total Pages</div>
          <div class="value" id="statPages">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Published</div>
          <div class="value" id="statPublished">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Nav Links</div>
          <div class="value" id="statNav">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Footer Links</div>
          <div class="value" id="statFooter">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Staff Members</div>
          <div class="value" id="statStaff">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Published Posts</div>
          <div class="value" id="statPosts">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Testimonials</div>
          <div class="value" id="statTestimonials">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Locations</div>
          <div class="value" id="statLocations">0</div>
        </div>
      </div>

      <div class="panel">
        <h2>Recent Content</h2>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="dashboardRecent">
            <tr>
              <td colspan="4" class="empty-state" style="padding:24px 0">No pages yet. Go to Pages to create one.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ── Analytics / Insights ── -->
    <div id="analytics" class="section">
      <h1>Analytics</h1>
      <p class="subtitle">Privacy-first insights from anonymized, locally stored interaction data. No cookies, no third parties.</p>

      <div class="stats-grid" style="margin-bottom:24px">
        <div class="stat-card">
          <div class="label">Book Clicks</div>
          <div class="value" id="statBookClicks">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Submissions</div>
          <div class="value" id="statSubmissions">0</div>
        </div>
      </div>

      <!-- Lead Velocity -->
      <div class="panel insight-card">
        <h2>Lead Velocity</h2>
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:20px">Form submissions over the last 7 days</p>
        <div id="leadVelocityChart" class="velocity-chart"></div>
      </div>

      <!-- Top Interest -->
      <div class="panel insight-card" style="margin-top:24px">
        <h2>Top Interest</h2>
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:20px">Most selected goals from Path Finder and contact form</p>
        <div id="topInterestList" class="top-interest-list">
          <div class="empty-state">No data yet. Interactions will appear here.</div>
        </div>
      </div>

      <!-- Language Pulse -->
      <div class="panel insight-card" style="margin-top:24px">
        <h2>Language Pulse</h2>
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:20px">Language distribution across book clicks and submissions</p>
        <div id="languagePulse" style="display:flex;align-items:center;gap:32px;flex-wrap:wrap">
          <canvas id="langPieCanvas" width="160" height="160" style="flex-shrink:0"></canvas>
          <div id="langPieLegend" class="lang-legend"></div>
        </div>
      </div>

      <!-- Regional Heatmap -->
      <div class="panel insight-card" style="margin-top:24px">
        <h2>Regional Heatmap</h2>
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:20px">Top locations by visitor interactions</p>
        <div id="regionalHeatmap" class="top-interest-list">
          <div class="empty-state">No geographic data yet. Locations will appear as visitors interact.</div>
        </div>
      </div>

      <!-- Device Engagement -->
      <div class="panel insight-card" style="margin-top:24px">
        <h2>Device Engagement</h2>
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:20px">Mobile vs Desktop interactions</p>
        <div id="deviceEngagement" style="display:flex;align-items:center;gap:32px;flex-wrap:wrap">
          <canvas id="devicePieCanvas" width="160" height="160" style="flex-shrink:0"></canvas>
          <div id="devicePieLegend" class="lang-legend"></div>
        </div>
      </div>

      <div style="margin-top:24px">
        <button class="btn btn-secondary" id="btnClearAnalytics">Clear Test Data</button>
      </div>
    </div>

    <!-- ── Site Settings ── -->
    <div id="settings" class="section">
      <h1>Site Settings</h1>
      <p class="subtitle">Customize fonts, colors, and the hero background. Changes are saved to localStorage and apply across the site.</p>

      <div class="panel">
        <h2>Typography</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="primaryFont">Primary Font</label>
            <select id="primaryFont">
              <option value="'Inter', system-ui, -apple-system, sans-serif">Inter (Default)</option>
              <option value="'SF Pro Display', system-ui, -apple-system, sans-serif">SF Pro Display</option>
              <option value="Georgia, 'Times New Roman', serif">Georgia</option>
              <option value="'Courier New', Courier, monospace">Courier New</option>
              <option value="system-ui, sans-serif">System UI</option>
            </select>
          </div>
          <div class="form-group">
            <label for="headingFont">Heading Font</label>
            <select id="headingFont">
              <option value="'Inter', system-ui, -apple-system, sans-serif">Inter (Default)</option>
              <option value="'SF Pro Display', system-ui, -apple-system, sans-serif">SF Pro Display</option>
              <option value="Georgia, 'Times New Roman', serif">Georgia</option>
              <option value="'Courier New', Courier, monospace">Courier New</option>
              <option value="system-ui, sans-serif">System UI</option>
            </select>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Colors</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="accentColor">Accent Color</label>
            <input type="color" id="accentColor" value="#1d1d1f">
          </div>
          <div class="form-group"></div>
        </div>
      </div>

      <div class="panel">
        <h2>Hero Background</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="heroImage">Day Image URL <button type="button" class="browse-btn" data-target="heroImage">&#128194; Browse</button></label>
            <input type="text" id="heroImage" placeholder="https://example.com/hero-day.jpg">
          </div>
          <div class="form-group">
            <label for="heroImageNight">Night Image URL <button type="button" class="browse-btn" data-target="heroImageNight">&#128194; Browse</button></label>
            <input type="text" id="heroImageNight" placeholder="https://example.com/hero-night.jpg (optional)">
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Button Style</h2>
        <div class="form-group">
          <label for="btnStyleSelect">Style</label>
          <select id="btnStyleSelect">
            <option value="pill">Pill (Rounded, Apple-esque)</option>
            <option value="modern">Modern (8px rounding)</option>
            <option value="glass">Glass (Semi-transparent + border)</option>
          </select>
        </div>
      </div>

      <div class="panel">
        <h2>Consultation Pop-up</h2>
        <div class="checkbox-row">
          <label>
            <input type="checkbox" id="consultPopupEnabled" checked>
            Enable Consultation Pop-up
          </label>
        </div>
      </div>

      <button class="btn-save" id="saveSettings">Save Settings</button>

      <iframe id="previewFrame" class="preview-frame" src="index.html" title="Live Preview"></iframe>
    </div>

    <!-- ── Homepage Layout ── -->
    <div id="homepage" class="section">
      <h1>Homepage Layout</h1>
      <p class="subtitle">Configure the bento tiles displayed on the homepage (up to 5 tiles).</p>

      <div class="panel">
        <div class="page-list-header">
          <h2>Bento Tiles</h2>
          <button class="btn btn-primary btn-sm" id="btnAddTile">Add Tile</button>
        </div>

        <div id="bentoTileEditors"></div>

        <button class="btn-save" id="saveBentoTiles">Save Layout</button>
      </div>

      <div class="panel" style="margin-top:24px">
        <h2>Preview</h2>
        <p class="subtitle" style="margin-bottom:16px">Live preview of your bento grid layout.</p>
        <div id="bentoPreview" style="display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:1fr;grid-auto-flow:dense;gap:12px;max-width:100%"></div>
      </div>
    </div>

    <!-- ── Trust & Social Proof ── -->
    <div id="trustproof" class="section">
      <h1>Trust & Social Proof</h1>
      <p class="subtitle">Manage the Success Ribbon that displays rotating phrases below the hero section.</p>

      <div class="panel">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:400;text-transform:none;letter-spacing:normal;margin-bottom:20px">
          <input type="checkbox" id="ribbonEnabled">
          Show Success Ribbon on all pages with a hero section
        </label>

        <h3 style="font-size:0.9375rem;font-weight:600;margin-bottom:12px">Success Phrases</h3>
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:16px">Phrases fade in and out one at a time. Add as many as you like.</p>
        <div id="ribbonPhrasesList" style="display:grid;gap:8px;margin-bottom:16px"></div>
        <div style="display:flex;gap:8px">
          <input type="text" id="newRibbonPhrase" placeholder="e.g. Over 5,000 families reunited" style="flex:1">
          <button class="btn btn-primary" id="btnAddRibbonPhrase">Add Phrase</button>
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Text Styles</h2>
      <div class="panel">
        <div class="form-group" style="margin-bottom:16px">
          <label for="ribbonFontSize">Font Size: <span id="ribbonFontSizeValue">13</span>px</label>
          <input type="range" id="ribbonFontSize" min="10" max="20" value="13" style="width:100%">
        </div>
        <div style="display:flex;gap:16px;margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;text-transform:none;letter-spacing:normal">
            <input type="checkbox" id="ribbonBold"> Bold
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;text-transform:none;letter-spacing:normal">
            <input type="checkbox" id="ribbonItalic"> Italic
          </label>
        </div>
        <div class="form-group">
          <label for="ribbonColor">Text Color</label>
          <div style="display:flex;align-items:center;gap:12px">
            <input type="color" id="ribbonColor" value="#3b82f6" style="width:48px;height:36px;border:1px solid var(--light-gray);border-radius:8px;cursor:pointer;padding:2px">
            <span id="ribbonColorHex" style="font-size:0.8125rem;color:var(--mid-gray)">#3b82f6</span>
          </div>
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Background Style</h2>
      <div class="panel">
        <div class="form-group">
          <label for="ribbonBgOpacity">Bar Opacity: <span id="ribbonBgOpacityValue">6</span>%</label>
          <input type="range" id="ribbonBgOpacity" min="0" max="100" value="6" style="width:100%">
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">Controls the background opacity of the ribbon bar. 0% = fully transparent, 100% = fully opaque.</p>
        </div>
      </div>

      <div style="margin-top:20px">
        <button class="btn btn-primary" id="btnSaveRibbon">Save Ribbon Settings</button>
      </div>
    </div>

    <!-- ── Pages ── -->
    <div id="pages" class="section">
      <h1>Pages</h1>
      <p class="subtitle">Create and manage site pages. Pages can appear in the top navigation, footer, or both.</p>

      <!-- Page list -->
      <div class="panel" id="pageListPanel">
        <div class="page-list-header">
          <h2>All Pages</h2>
          <button class="btn btn-primary btn-sm" id="btnAddPage">Add New Page</button>
        </div>
        <div id="pageList">
          <div class="empty-state">No pages yet. Click "Add New Page" to get started.</div>
        </div>
      </div>

      <!-- Page form (add / edit) -->
      <div class="panel page-form-panel" id="pageFormPanel">
        <h2 id="pageFormTitle">Add New Page</h2>
        <input type="hidden" id="pageEditId" value="">

        <div class="form-row">
          <div class="form-group">
            <label for="pageTitleInput">Page Title</label>
            <input type="text" id="pageTitleInput" placeholder="About Us">
          </div>
          <div class="form-group">
            <label for="pageSlugInput">URL Slug</label>
            <input type="text" id="pageSlugInput" placeholder="about">
          </div>
        </div>

        <div class="form-group">
          <label for="pageContentInput">Content</label>
          <textarea id="pageContentInput" placeholder="Write your page content here..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="pageSeoTitle">SEO Title</label>
            <input type="text" id="pageSeoTitle" placeholder="Custom title for search engines">
          </div>
          <div class="form-group">
            <label for="pageMetaDesc">Meta Description</label>
            <input type="text" id="pageMetaDesc" placeholder="Brief description for search results">
          </div>
        </div>

        <div class="checkbox-row">
          <label>
            <input type="checkbox" id="pageShowNav">
            Show in Top Navigation
          </label>
          <label>
            <input type="checkbox" id="pageShowFooter">
            Show in Footer
          </label>
          <label>
            <input type="checkbox" id="pagePublished">
            Published
          </label>
        </div>

        <div style="display:flex;gap:12px">
          <button class="btn btn-primary" id="btnSavePage">Save Page</button>
          <button class="btn btn-secondary" id="btnCancelPage">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ── Posts ── -->
    <div id="posts" class="section">
      <h1>Posts</h1>
      <p class="subtitle">Manage your blog posts.</p>

      <!-- Post list -->
      <div class="panel" id="postListPanel">
        <div class="page-list-header">
          <h2>All Posts</h2>
          <button class="btn btn-primary btn-sm" id="btnAddPost">Add New Post</button>
        </div>
        <div id="postList">
          <div class="empty-state">No posts yet. Click "Add New Post" to get started.</div>
        </div>
      </div>

      <!-- Post form (add / edit) -->
      <div class="panel page-form-panel" id="postFormPanel">
        <h2 id="postFormTitle">Add New Post</h2>
        <input type="hidden" id="postEditId" value="">

        <div class="form-row">
          <div class="form-group">
            <label for="postTitleInput">Title</label>
            <input type="text" id="postTitleInput" placeholder="Post title">
          </div>
          <div class="form-group">
            <label for="postSlugInput">Slug</label>
            <input type="text" id="postSlugInput" placeholder="post-slug">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="postDateInput">Date</label>
            <input type="date" id="postDateInput">
          </div>
          <div class="form-group">
            <label for="postCategoryInput">Category</label>
            <select id="postCategoryInput">
              <option value="News">News</option>
              <option value="Policy Update">Policy Update</option>
              <option value="Case Study">Case Study</option>
              <option value="Community">Community</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="postContentInput">Content</label>
          <textarea id="postContentInput" placeholder="Write your post content here..." style="min-height:240px"></textarea>
        </div>

        <div class="checkbox-row">
          <label>
            <input type="checkbox" id="postPublished" checked>
            Published
          </label>
        </div>

        <div style="display:flex;gap:12px">
          <button class="btn btn-primary" id="btnSavePost">Save Post</button>
          <button class="btn btn-secondary" id="btnCancelPost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ── Staff ── -->
    <div id="staff" class="section">
      <h1>Staff</h1>
      <p class="subtitle">Manage your team members.</p>

      <!-- Staff list -->
      <div class="panel" id="staffListPanel">
        <div class="page-list-header">
          <h2>All Staff</h2>
          <button class="btn btn-primary btn-sm" id="btnAddStaff">Add Staff Member</button>
        </div>
        <div id="staffList">
          <div class="empty-state">No staff yet. Click "Add Staff Member" to get started.</div>
        </div>
      </div>

      <!-- Staff form (add / edit) -->
      <div class="panel page-form-panel" id="staffFormPanel">
        <h2 id="staffFormTitle">Add Staff Member</h2>
        <input type="hidden" id="staffEditId" value="">

        <div class="form-row">
          <div class="form-group">
            <label for="staffNameInput">Name</label>
            <input type="text" id="staffNameInput" placeholder="Full name">
          </div>
          <div class="form-group">
            <label for="staffTitleInput">Title</label>
            <input type="text" id="staffTitleInput" placeholder="Senior Attorney">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="staffOfficeInput">Primary Location</label>
            <select id="staffOfficeInput">
              <!-- Populated dynamically from siteOfficeLocations -->
            </select>
          </div>
          <div class="form-group">
            <label for="staffImageInput">Image URL <button type="button" class="browse-btn" data-target="staffImageInput">&#128194; Browse</button></label>
            <input type="text" id="staffImageInput" placeholder="https://example.com/photo.jpg">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="staffEmailInput">Direct Email</label>
            <input type="email" id="staffEmailInput" placeholder="name@obrienimmigration.com">
          </div>
          <div class="form-group">
            <label for="staffPhoneInput">Direct Phone</label>
            <input type="tel" id="staffPhoneInput" placeholder="(510) 555-0100">
          </div>
        </div>

        <div class="form-group">
          <label for="staffBioInput">Bio</label>
          <textarea id="staffBioInput" placeholder="Staff member bio..."></textarea>
        </div>

        <div class="checkbox-row">
          <label>
            <input type="checkbox" id="staffShowOnWebsite" checked>
            Show on Website
          </label>
        </div>

        <div class="checkbox-row">
          <label>
            <input type="checkbox" id="staffHiring">
            Actively Hiring
          </label>
        </div>

        <div style="display:flex;gap:12px">
          <button class="btn btn-primary" id="btnSaveStaff">Save Staff Member</button>
          <button class="btn btn-secondary" id="btnCancelStaff">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ── Testimonials ── -->
    <div id="testimonials" class="section">
      <h1>Testimonials</h1>
      <p class="subtitle">Manage client testimonials displayed on the Wall of Love page.</p>

      <!-- Testimonial list -->
      <div class="panel" id="testimonialListPanel">
        <div class="page-list-header">
          <h2>All Testimonials</h2>
          <button class="btn btn-primary btn-sm" id="btnAddTestimonial">Add Testimonial</button>
        </div>
        <div id="testimonialList">
          <div class="empty-state">No testimonials yet. Click "Add Testimonial" to get started.</div>
        </div>
      </div>

      <!-- Testimonial form (add / edit) -->
      <div class="panel page-form-panel" id="testimonialFormPanel">
        <h2 id="testimonialFormTitle">Add Testimonial</h2>
        <input type="hidden" id="testimonialEditId" value="">

        <div class="form-row">
          <div class="form-group">
            <label for="testimonialNameInput">Client Name</label>
            <input type="text" id="testimonialNameInput" placeholder="Client name">
          </div>
          <div class="form-group">
            <label for="testimonialAreaInput">Practice Area</label>
            <select id="testimonialAreaInput">
              <option value="Asylum">Asylum</option>
              <option value="Family">Family</option>
              <option value="Removal">Removal</option>
              <option value="Citizenship">Citizenship</option>
              <option value="Work Visas">Work Visas</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="testimonialQuoteInput">Quote</label>
          <textarea id="testimonialQuoteInput" placeholder="What the client said..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="testimonialRatingInput">Star Rating (1–5)</label>
            <select id="testimonialRatingInput">
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
          </div>
          <div class="form-group"></div>
        </div>

        <div class="checkbox-row">
          <label>
            <input type="checkbox" id="testimonialActive" checked>
            Active (visible on website)
          </label>
        </div>

        <div style="display:flex;gap:12px">
          <button class="btn btn-primary" id="btnSaveTestimonial">Save Testimonial</button>
          <button class="btn btn-secondary" id="btnCancelTestimonial">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ── Office Locations Picklist ── -->
    <div id="officelocations" class="section">
      <h1>Office Locations</h1>
      <p class="subtitle">Manage the master list of office names. This list feeds into the Staff page location filter, the staff edit form, and the consultation contact form.</p>

      <div class="panel">
        <div id="officeLocationsList" style="display:grid;gap:8px;margin-bottom:16px"></div>
        <div style="display:flex;gap:8px">
          <input type="text" id="newOfficeLocationInput" placeholder="e.g. Oakland" style="flex:1">
          <button class="btn btn-primary" id="btnAddOfficeLocation">Add Location</button>
        </div>
      </div>
    </div>

    <!-- ── Locations ── -->
    <div id="locations" class="section">
      <h1>Locations</h1>
      <p class="subtitle">Manage your office locations displayed on the Locations page.</p>

      <!-- Location list -->
      <div class="panel" id="locationListPanel">
        <div class="page-list-header">
          <h2>All Locations</h2>
          <button class="btn btn-primary btn-sm" id="btnAddLocation">Add Location</button>
        </div>
        <div id="locationList">
          <div class="empty-state">No locations yet. Click "Add Location" to get started.</div>
        </div>
      </div>

      <!-- Location form (add / edit) -->
      <div class="panel page-form-panel" id="locationFormPanel">
        <h2 id="locationFormTitle">Add Location</h2>
        <input type="hidden" id="locationEditId" value="">

        <div class="form-row">
          <div class="form-group">
            <label for="locationNameInput">Office Name</label>
            <input type="text" id="locationNameInput" placeholder="Berkeley Office">
          </div>
          <div class="form-group">
            <label for="locationTaglineInput">Tagline</label>
            <input type="text" id="locationTaglineInput" placeholder="Serving the East Bay since 2010">
          </div>
        </div>

        <div class="form-group">
          <label for="locationAddressInput">Address</label>
          <input type="text" id="locationAddressInput" placeholder="123 Main St, Berkeley, CA 94704">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="locationPhoneInput">Phone</label>
            <input type="text" id="locationPhoneInput" placeholder="(510) 555-0100">
          </div>
          <div class="form-group">
            <label for="locationEmailInput">Email</label>
            <input type="text" id="locationEmailInput" placeholder="berkeley@obrienimmigration.com">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="locationPhotoInput">Day Photo URL <button type="button" class="browse-btn" data-target="locationPhotoInput">&#128194; Browse</button></label>
            <input type="text" id="locationPhotoInput" placeholder="https://images.unsplash.com/...day">
          </div>
          <div class="form-group">
            <label for="locationPhotoNightInput">Night Photo URL <button type="button" class="browse-btn" data-target="locationPhotoNightInput">&#128194; Browse</button></label>
            <input type="text" id="locationPhotoNightInput" placeholder="https://...night (optional)">
          </div>
        </div>

        <div class="form-group">
          <label for="locationParkingInput">Parking & Access Info</label>
          <textarea id="locationParkingInput" placeholder="Free street parking available..." style="min-height:80px"></textarea>
        </div>

        <div class="form-group">
          <label for="locationSpecialtiesInput">Specialties</label>
          <textarea id="locationSpecialtiesInput" placeholder="Asylum, Family Petitions, Removal Defense..." style="min-height:80px"></textarea>
        </div>

        <div style="display:flex;gap:12px">
          <button class="btn btn-primary" id="btnSaveLocation">Save Location</button>
          <button class="btn btn-secondary" id="btnCancelLocation">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ── Business Hours ── -->
    <div id="businesshours" class="section">
      <h1>Business Hours</h1>
      <p class="subtitle">Set your office hours and special closures. Powers the living clock and status indicator on the public site.</p>

      <div class="panel">
        <h2>Standard Hours</h2>
        <p style="font-size:0.875rem;color:var(--mid-gray);margin-bottom:20px">Set daily open/close times. Leave blank or check "Closed" for days the office is closed.</p>
        <div id="hoursGrid" style="display:grid;gap:12px">
          <!-- Rendered by JS -->
        </div>
        <div style="margin-top:20px">
          <button class="btn btn-primary" id="btnSaveHours">Save Hours</button>
        </div>
      </div>

      <div class="panel" style="margin-top:24px">
        <div class="page-list-header">
          <h2>Special Closures</h2>
          <button class="btn btn-primary btn-sm" id="btnAddClosure">Add Closure</button>
        </div>
        <div id="closureForm" style="display:none;margin-bottom:20px">
          <div class="form-row">
            <div class="form-group">
              <label for="closureDateInput">Date</label>
              <input type="date" id="closureDateInput">
            </div>
            <div class="form-group">
              <label for="closureLabelInput">Label</label>
              <input type="text" id="closureLabelInput" placeholder="e.g. Independence Day">
            </div>
          </div>
          <div style="display:flex;gap:12px">
            <button class="btn btn-primary btn-sm" id="btnSaveClosure">Add</button>
            <button class="btn btn-secondary btn-sm" id="btnCancelClosure">Cancel</button>
          </div>
        </div>
        <div id="closureList">
          <div class="empty-state">No special closures set.</div>
        </div>
      </div>
    </div>

    <!-- ── Navigation & Visibility ── -->
    <div id="navfooter" class="section">
      <h1>Navigation & Footer</h1>
      <p class="subtitle">Control which links appear in the header navigation and footer, configure the language globe, and set copyright text.</p>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:24px;margin-bottom:12px;letter-spacing:-0.02em">Header Navigation</h2>
      <div class="panel">
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:16px">Toggle links on or off in the top navigation bar.</p>
        <div style="display:grid;gap:12px">
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Home</span>
            <input type="checkbox" id="nfNavHome">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Services</span>
            <input type="checkbox" id="nfNavServices">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Staff</span>
            <input type="checkbox" id="nfNavStaff">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Testimonials</span>
            <input type="checkbox" id="nfNavTestimonials">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Education</span>
            <input type="checkbox" id="nfNavEducation">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Locations</span>
            <input type="checkbox" id="nfNavLocations">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Careers</span>
            <input type="checkbox" id="nfNavCareers">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Client Portal</span>
            <input type="checkbox" id="nfNavPortal">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Book a Consultation (CTA)</span>
            <input type="checkbox" id="nfNavBookConsultation">
          </label>
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Navigation Layout</h2>
      <div class="panel">
        <div class="form-group">
          <label for="nfMaxNavItems">Max Nav Items: <span id="nfMaxNavItemsValue">5</span></label>
          <input type="range" id="nfMaxNavItems" min="2" max="8" value="5" style="width:100%">
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">Links beyond this limit collapse into a "More" dropdown.</p>
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Mobile Collapse Trigger</h2>
      <div class="panel">
        <div class="form-group">
          <label for="nfMobileBreakpoint">Collapse below: <span id="nfMobileBreakpointValue">768</span>px</label>
          <input type="range" id="nfMobileBreakpoint" min="480" max="1200" step="8" value="768" style="width:100%">
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">Screen widths below this value will show a hamburger menu instead of the full navigation bar.</p>
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Footer Links</h2>
      <div class="panel">
        <p style="font-size:0.8125rem;color:var(--mid-gray);margin-bottom:16px">Toggle links on or off in the site footer.</p>
        <div style="display:grid;gap:12px">
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Home</span>
            <input type="checkbox" id="nfFooterHome">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Services</span>
            <input type="checkbox" id="nfFooterServices">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Our Team</span>
            <input type="checkbox" id="nfFooterStaff">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Testimonials</span>
            <input type="checkbox" id="nfFooterTestimonials">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Education</span>
            <input type="checkbox" id="nfFooterEducation">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Locations</span>
            <input type="checkbox" id="nfFooterLocations">
          </label>
          <label style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--off-white);border-radius:var(--radius-sm);cursor:pointer">
            <span style="font-size:0.875rem;font-weight:500">Careers</span>
            <input type="checkbox" id="nfFooterCareers">
          </label>
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Copyright Statement</h2>
      <div class="panel">
        <div class="form-group">
          <label for="nfCopyright">Copyright Text</label>
          <input type="text" id="nfCopyright" placeholder="&copy; 2026 O'Brien Immigration Law. All rights reserved.">
        </div>
      </div>

      <h2 style="font-size:1.125rem;font-weight:600;margin-top:32px;margin-bottom:12px;letter-spacing:-0.02em">Legal Disclaimer</h2>
      <div class="panel">
        <div class="form-group">
          <label for="nfDisclaimer">Disclaimer Text</label>
          <textarea id="nfDisclaimer" rows="3" placeholder="Optional legal disclaimer that appears below the copyright in the footer"></textarea>
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">Leave blank to hide. Appears below the copyright text on all pages.</p>
        </div>
      </div>

      <div style="margin-top:24px">
        <button class="btn btn-primary" id="btnSaveNavFooter">Save Navigation & Footer Settings</button>
      </div>
    </div>

    <!-- ── Contact Config ── -->
    <div id="contactconfig" class="section">
      <h1>Contact Config</h1>
      <p class="subtitle">Configure the consultation form endpoint and test your connection.</p>

      <div class="panel">
        <div class="form-group">
          <label for="formspreeUrlInput">Formspree Endpoint URL</label>
          <input type="text" id="formspreeUrlInput" placeholder="https://formspree.io/f/your-form-id">
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">The full Formspree URL where consultation form submissions are sent.</p>
        </div>

        <div style="display:flex;gap:12px;margin-top:20px">
          <button class="btn btn-primary" id="btnSaveContactConfig">Save</button>
          <button class="btn btn-secondary" id="btnTestConnection">Test Connection</button>
        </div>
        <div id="testConnectionResult" style="margin-top:12px;font-size:0.875rem;display:none"></div>
      </div>
    </div>

    <!-- ── Clock Settings ── -->
    <div id="clocksettings" class="section">
      <h1>Clock Settings</h1>
      <p class="subtitle">Control the living clock display on the hero section. Change visibility, position, and city label.</p>

      <div class="panel">
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:400;text-transform:none;letter-spacing:normal">
            <input type="checkbox" id="clockVisibleToggle" checked>
            Show Clock on Hero Section
          </label>
        </div>

        <div class="form-group">
          <label for="clockPositionSelect">Position</label>
          <select id="clockPositionSelect">
            <option value="center">Center (above headline)</option>
            <option value="top-left">Top Left</option>
            <option value="top-right">Top Right</option>
            <option value="bottom-left">Bottom Left</option>
            <option value="bottom-right">Bottom Right</option>
          </select>
        </div>

        <div class="form-group">
          <label for="clockLabelInput">City Label</label>
          <input type="text" id="clockLabelInput" placeholder="e.g. San Francisco, Berkeley, Oakland">
        </div>

        <div style="margin-top:20px">
          <button class="btn btn-primary" id="btnSaveClockSettings">Save Clock Settings</button>
        </div>
      </div>
    </div>

    <!-- ── Translation ── -->
    <div id="translation" class="section">
      <h1>Translation</h1>
      <p class="subtitle">Configure the automated translation system. A legal disclaimer appears on the public site when a non-English language is active.</p>

      <div class="panel">
        <div class="form-group">
          <label for="translationDisclaimer">Legal Disclaimer</label>
          <textarea id="translationDisclaimerInput" rows="3" placeholder="This translation is automated for your convenience..."></textarea>
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">This text appears in a bar at the bottom of the page when a visitor is viewing the site in a non-English language.</p>
        </div>

        <div style="margin-top:20px">
          <button class="btn btn-primary" id="btnSaveTranslation">Save Translation Settings</button>
        </div>
      </div>
    </div>

    <!-- ── Salesforce & Box ── -->
    <div id="salesforcebox" class="section">
      <h1>Salesforce & Box</h1>
      <p class="subtitle">Configure Salesforce CRM and Box document storage integrations for the client portal.</p>

      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
          <h2 style="font-size:1.1rem;font-weight:600;margin:0">Salesforce Configuration</h2>
          <span id="sfConnectionStatus" style="font-size:0.75rem;display:inline-flex;align-items:center;gap:4px"><span style="color:#d63031">&#9679;</span> Disconnected</span>
        </div>

        <div class="form-group">
          <label for="sfConsumerKey">Consumer Key</label>
          <input type="text" id="sfConsumerKey" placeholder="3MVG9...">
        </div>

        <div class="form-group">
          <label for="sfConsumerSecret">Consumer Secret</label>
          <input type="password" id="sfConsumerSecret" placeholder="••••••••">
        </div>

        <div class="form-group">
          <label for="sfInstanceUrl">Instance URL</label>
          <input type="text" id="sfInstanceUrl" placeholder="https://yourorg.my.salesforce.com">
        </div>

        <div style="margin-top:16px">
          <button class="btn btn-secondary" id="btnTestSalesforce">Test Connection</button>
        </div>
        <div id="sfTestResult" style="margin-top:12px;font-size:0.875rem;display:none"></div>
      </div>

      <div class="panel" style="margin-top:24px">
        <h2 style="font-size:1.1rem;font-weight:600;margin-bottom:20px">Box Configuration</h2>

        <div class="form-group">
          <label for="boxFolderId">Box Folder ID</label>
          <input type="text" id="boxFolderId" placeholder="e.g. 123456789">
          <p style="font-size:0.75rem;color:var(--mid-gray);margin-top:6px">The root folder in Box where client documents are stored.</p>
        </div>
      </div>

      <div style="margin-top:24px">
        <button class="btn btn-primary" id="btnSaveSalesforceBox">Save</button>
      </div>
    </div>

    <!-- ── Education Logic ── -->
    <div id="education" class="section">
      <h1>Education Logic</h1>
      <p class="subtitle">Configure the Path Finder tool on the Education page. Edit status categories, goals, and result text without touching code.</p>

      <!-- Picklist Cards -->
      <div class="edu-cards-row">
        <!-- Status Options Card -->
        <div class="edu-card">
          <div class="edu-card-header">
            <h2>Status Options <span style="font-weight:400;color:var(--mid-gray)">("I am a...")</span></h2>
            <span class="edu-card-count" id="eduStatusCount">0</span>
          </div>
          <div id="eduStatusList"></div>
          <div id="eduStatusInlineForm" style="display:none"></div>
          <button class="edu-add-btn" id="btnAddStatus">+ Add New Status</button>
        </div>

        <!-- Goal Options Card -->
        <div class="edu-card">
          <div class="edu-card-header">
            <h2>Goal Options <span style="font-weight:400;color:var(--mid-gray)">("I want to...")</span></h2>
            <span class="edu-card-count" id="eduGoalCount">0</span>
          </div>
          <p style="font-size:0.8rem;color:var(--mid-gray);margin-bottom:12px" id="eduGoalHint">Select a status to view its goals.</p>
          <div id="eduGoalListNew"></div>
          <div id="eduGoalInlineForm" style="display:none"></div>
          <button class="edu-add-btn" id="btnAddGoal" style="display:none">+ Add New Goal</button>
        </div>
      </div>

      <!-- Logic Map -->
      <div class="logic-map-section panel">
        <h2>Logic Map</h2>
        <p class="subtitle">Edit the result text shown for each Status + Goal combination.</p>
        <div id="logicMapContainer">
          <div class="empty-state">Loading logic map...</div>
        </div>
        <div class="logic-map-save-row">
          <button class="btn btn-primary" id="btnSaveLogicMap">Save All Changes</button>
        </div>
      </div>
    </div>

    <div id="media" class="section">
      <h1>Media</h1>
      <p class="subtitle">Upload images directly to your GitHub repo or add external URLs. All files go to the <code>/assets/</code> folder.</p>

      <div class="panel">
        <h2>Upload to GitHub</h2>
        <div class="media-drop-zone" id="mediaDropZone">
          <input type="file" id="mediaFileInput" accept="image/*" multiple>
          <div class="media-drop-icon">&#128206;</div>
          <div class="media-drop-text">Drag &amp; drop images here, or click to browse</div>
          <div class="media-drop-hint">PNG, JPG, GIF, SVG, WebP &mdash; up to 10 MB each</div>
          <div class="media-progress" id="mediaProgress">
            <div class="media-progress-bar"><div class="media-progress-fill" id="mediaProgressFill"></div></div>
            <div class="media-progress-text" id="mediaProgressText">Uploading...</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:20px">
          <button class="btn btn-secondary btn-sm" id="btnGhSettings" title="Configure GitHub PAT">&#9881; GitHub Settings</button>
          <span id="ghStatusBadge" style="font-size:0.75rem;color:var(--mid-gray)"></span>
        </div>
      </div>

      <div class="panel">
        <div class="page-list-header">
          <h2>Media Library</h2>
          <button class="btn btn-primary btn-sm" id="btnAddMedia">Add Image URL</button>
        </div>

        <div class="media-form" id="mediaForm">
          <div class="form-group">
            <label for="mediaUrlInput">Image URL</label>
            <input type="text" id="mediaUrlInput" placeholder="https://example.com/image.jpg">
          </div>
          <div class="form-group">
            <label for="mediaLabelInput">Label / Alt Text</label>
            <input type="text" id="mediaLabelInput" placeholder="Descriptive label for this image">
          </div>
          <div style="display:flex;gap:12px">
            <button class="btn btn-primary btn-sm" id="btnSaveMedia">Save</button>
            <button class="btn btn-secondary btn-sm" id="btnCancelMedia">Cancel</button>
          </div>
        </div>

        <div id="mediaList">
          <div class="empty-state">No media yet. Upload files or click "Add Image URL" to get started.</div>
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script src="analytics.js"></script>
  <script>
    /* ══════════════════════════════════════════════
       Helpers
       ══════════════════════════════════════════════ */

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }

    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    /* ══════════════════════════════════════════════
       Sidebar accordion navigation
       ══════════════════════════════════════════════ */

    const sidebarLinks = document.querySelectorAll(".sidebar-link[data-section]");
    const sections = document.querySelectorAll(".section");
    const sidebarGroups = document.querySelectorAll(".sidebar-group");

    // Accordion: only one group open at a time
    sidebarGroups.forEach(function(group) {
      var header = group.querySelector(".sidebar-group-header");
      header.addEventListener("click", function() {
        var isOpen = group.classList.contains("open");
        // Close all groups
        sidebarGroups.forEach(function(g) { g.classList.remove("open"); });
        // Toggle clicked group
        if (!isOpen) group.classList.add("open");
      });
    });

    // Section switching for all sidebar links
    sidebarLinks.forEach(function(link) {
      link.addEventListener("click", function() {
        sidebarLinks.forEach(function(l) { l.classList.remove("active"); });
        sections.forEach(function(s) { s.classList.remove("active"); });
        link.classList.add("active");
        var target = document.getElementById(link.dataset.section);
        if (target) target.classList.add("active");

        // Auto-open the parent group
        var parentGroup = link.closest(".sidebar-group");
        if (parentGroup) {
          sidebarGroups.forEach(function(g) { g.classList.remove("open"); });
          parentGroup.classList.add("open");
        }
      });
    });

    /* ══════════════════════════════════════════════
       Page data (localStorage)
       ══════════════════════════════════════════════ */

    function getPages() {
      return JSON.parse(localStorage.getItem("sitePages") || "[]");
    }

    function savePages(pages) {
      localStorage.setItem("sitePages", JSON.stringify(pages));
    }

    /* ══════════════════════════════════════════════
       Post data (localStorage)
       ══════════════════════════════════════════════ */

    function getPosts() {
      return JSON.parse(localStorage.getItem("sitePosts") || "[]");
    }

    function savePosts(posts) {
      localStorage.setItem("sitePosts", JSON.stringify(posts));
    }

    /* ══════════════════════════════════════════════
       Staff data (localStorage)
       ══════════════════════════════════════════════ */

    function getStaff() {
      return JSON.parse(localStorage.getItem("siteStaff") || "[]");
    }

    function saveStaff(staff) {
      localStorage.setItem("siteStaff", JSON.stringify(staff));
    }

    /* ══════════════════════════════════════════════
       Dashboard stats
       ══════════════════════════════════════════════ */

    function refreshDashboard() {
      const pages = getPages();
      const posts = getPosts();
      const staff = getStaff();
      const testimonials = getTestimonials();
      document.getElementById("statPages").textContent = pages.length;
      document.getElementById("statPublished").textContent = pages.filter((p) => p.published !== false).length;
      document.getElementById("statNav").textContent = pages.filter((p) => p.showInNav && p.published !== false).length;
      document.getElementById("statFooter").textContent = pages.filter((p) => p.showInFooter && p.published !== false).length;
      document.getElementById("statStaff").textContent = staff.length;
      document.getElementById("statPosts").textContent = posts.filter((p) => p.published).length;
      document.getElementById("statTestimonials").textContent = testimonials.filter((t) => t.active !== false).length;
      document.getElementById("statLocations").textContent = getLocations().length;

      const tbody = document.getElementById("dashboardRecent");
      // Combine pages and posts for recent content
      const allContent = [];
      pages.forEach((p) => {
        allContent.push({ title: p.title, type: 'Page', published: p.published !== false, date: p.createdAt || '\u2014', showInNav: p.showInNav, showInFooter: p.showInFooter });
      });
      posts.forEach((p) => {
        allContent.push({ title: p.title, type: 'Post', published: p.published, date: p.date || p.createdAt || '\u2014', category: p.category });
      });

      if (allContent.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state" style="padding:24px 0">No content yet. Go to Pages or Posts to create some.</td></tr>';
        return;
      }
      const recent = allContent.reverse().slice(0, 8);
      tbody.innerHTML = recent.map((item) => {
        const badges = [];
        if (item.published) {
          badges.push('<span class="badge published">Published</span>');
        } else {
          badges.push('<span class="badge draft">Draft</span>');
        }
        if (item.showInNav) badges.push('<span class="badge nav-badge">Nav</span>');
        if (item.showInFooter) badges.push('<span class="badge footer-badge">Footer</span>');
        if (item.category) badges.push('<span class="badge category-badge">' + escapeHtml(item.category) + '</span>');
        return '<tr>' +
          '<td>' + escapeHtml(item.title) + '</td>' +
          '<td>' + item.type + '</td>' +
          '<td>' + badges.join(' ') + '</td>' +
          '<td>' + escapeHtml(item.date) + '</td>' +
          '</tr>';
      }).join('');
    }

    /* ══════════════════════════════════════════════
       Pages list
       ══════════════════════════════════════════════ */

    function renderPageList() {
      const container = document.getElementById("pageList");
      const pages = getPages();

      if (pages.length === 0) {
        container.innerHTML = '<div class="empty-state">No pages yet. Click "Add New Page" to get started.</div>';
        return;
      }

      container.innerHTML = pages.map((p) => {
        const badges = [];
        const isPublished = p.published !== false;
        if (isPublished) {
          badges.push('<span class="badge published">Published</span>');
        } else {
          badges.push('<span class="badge draft">Draft</span>');
        }
        if (p.showInNav) badges.push('<span class="badge nav-badge">Nav</span>');
        if (p.showInFooter) badges.push('<span class="badge footer-badge">Footer</span>');
        return '<div class="page-row" data-id="' + p.id + '">' +
          '<div class="page-row-info">' +
            '<div class="page-row-title">' + escapeHtml(p.title) + '</div>' +
            '<div class="page-row-slug">/' + escapeHtml(p.slug) + '</div>' +
          '</div>' +
          '<div class="page-row-badges">' + badges.join('') + '</div>' +
          '<div class="page-row-actions">' +
            '<button class="btn btn-secondary btn-sm btn-edit-page">Edit</button>' +
            '<button class="btn btn-danger btn-sm btn-delete-page">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');

      // Bind edit buttons
      container.querySelectorAll(".btn-edit-page").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          editPage(id);
        });
      });

      // Bind delete buttons
      container.querySelectorAll(".btn-delete-page").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          deletePage(id);
        });
      });
    }

    /* ══════════════════════════════════════════════
       Page form (add / edit)
       ══════════════════════════════════════════════ */

    const pageFormPanel = document.getElementById("pageFormPanel");
    const pageListPanel = document.getElementById("pageListPanel");

    function showPageForm() {
      pageFormPanel.classList.add("visible");
      pageListPanel.style.display = "none";
    }

    function hidePageForm() {
      pageFormPanel.classList.remove("visible");
      pageListPanel.style.display = "";
      clearPageForm();
    }

    function clearPageForm() {
      document.getElementById("pageEditId").value = "";
      document.getElementById("pageTitleInput").value = "";
      document.getElementById("pageSlugInput").value = "";
      document.getElementById("pageContentInput").value = "";
      document.getElementById("pageSeoTitle").value = "";
      document.getElementById("pageMetaDesc").value = "";
      document.getElementById("pageShowNav").checked = false;
      document.getElementById("pageShowFooter").checked = false;
      document.getElementById("pagePublished").checked = true;
      document.getElementById("pageFormTitle").textContent = "Add New Page";
    }

    // Auto-generate slug from title
    document.getElementById("pageTitleInput").addEventListener("input", (e) => {
      const slugField = document.getElementById("pageSlugInput");
      const editId = document.getElementById("pageEditId").value;
      // Only auto-fill slug when creating new pages
      if (!editId) {
        slugField.value = e.target.value
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");
      }
    });

    document.getElementById("btnAddPage").addEventListener("click", () => {
      clearPageForm();
      showPageForm();
    });

    document.getElementById("btnCancelPage").addEventListener("click", hidePageForm);

    document.getElementById("btnSavePage").addEventListener("click", () => {
      const title = document.getElementById("pageTitleInput").value.trim();
      const slug = document.getElementById("pageSlugInput").value.trim()
        .toLowerCase().replace(/[^a-z0-9-]/g, "");
      const content = document.getElementById("pageContentInput").value;
      const seoTitle = document.getElementById("pageSeoTitle").value.trim();
      const metaDescription = document.getElementById("pageMetaDesc").value.trim();
      const showInNav = document.getElementById("pageShowNav").checked;
      const showInFooter = document.getElementById("pageShowFooter").checked;
      const published = document.getElementById("pagePublished").checked;
      const editId = document.getElementById("pageEditId").value;

      if (!title) { showToast("Title is required"); return; }
      if (!slug) { showToast("Slug is required"); return; }

      const pages = getPages();

      // Check for duplicate slug
      const duplicate = pages.find((p) => p.slug === slug && p.id !== editId);
      if (duplicate) { showToast("A page with this slug already exists"); return; }

      if (editId) {
        // Update existing
        const idx = pages.findIndex((p) => p.id === editId);
        if (idx !== -1) {
          pages[idx].title = title;
          pages[idx].slug = slug;
          pages[idx].content = content;
          pages[idx].seoTitle = seoTitle;
          pages[idx].metaDescription = metaDescription;
          pages[idx].showInNav = showInNav;
          pages[idx].showInFooter = showInFooter;
          pages[idx].published = published;
        }
        showToast("Page updated");
      } else {
        // Create new
        const now = new Date();
        const dateStr = now.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        pages.push({
          id: generateId(),
          title: title,
          slug: slug,
          content: content,
          seoTitle: seoTitle,
          metaDescription: metaDescription,
          showInNav: showInNav,
          showInFooter: showInFooter,
          published: published,
          createdAt: dateStr
        });
        showToast("Page created");
      }

      savePages(pages);
      hidePageForm();
      renderPageList();
      refreshDashboard();
      console.log("Pages saved:", pages);
    });

    function editPage(id) {
      const pages = getPages();
      const page = pages.find((p) => p.id === id);
      if (!page) return;

      document.getElementById("pageEditId").value = page.id;
      document.getElementById("pageTitleInput").value = page.title;
      document.getElementById("pageSlugInput").value = page.slug;
      document.getElementById("pageContentInput").value = page.content;
      document.getElementById("pageSeoTitle").value = page.seoTitle || "";
      document.getElementById("pageMetaDesc").value = page.metaDescription || "";
      document.getElementById("pageShowNav").checked = page.showInNav;
      document.getElementById("pageShowFooter").checked = page.showInFooter;
      document.getElementById("pagePublished").checked = page.published !== false;
      document.getElementById("pageFormTitle").textContent = "Edit Page";

      showPageForm();
    }

    function deletePage(id) {
      const pages = getPages();
      const page = pages.find((p) => p.id === id);
      if (!page) return;

      if (!confirm('Delete "' + page.title + '"? This cannot be undone.')) return;

      const updated = pages.filter((p) => p.id !== id);
      savePages(updated);
      renderPageList();
      refreshDashboard();
      showToast("Page deleted");
    }

    /* ══════════════════════════════════════════════
       Site Settings (existing)
       ══════════════════════════════════════════════ */

    const saved = JSON.parse(localStorage.getItem("siteSettings") || "{}");

    const primaryFontSelect = document.getElementById("primaryFont");
    const headingFontSelect = document.getElementById("headingFont");
    const accentColorInput = document.getElementById("accentColor");
    const heroImageInput = document.getElementById("heroImage");
    const heroImageNightInput = document.getElementById("heroImageNight");

    const consultToggle = document.getElementById("consultPopupEnabled");
    const btnStyleSelect = document.getElementById("btnStyleSelect");

    if (saved["--primary-font"]) primaryFontSelect.value = saved["--primary-font"];
    if (saved["--heading-font"]) headingFontSelect.value = saved["--heading-font"];
    if (saved["--accent-color"]) accentColorInput.value = saved["--accent-color"];
    if (saved["--hero-bg-image"]) {
      const url = saved["--hero-bg-image"].replace(/^url\(["']?/, "").replace(/["']?\)$/, "");
      if (url !== "none") heroImageInput.value = url;
    }
    if (saved["--hero-bg-image-night"]) {
      const url = saved["--hero-bg-image-night"].replace(/^url\(["']?/, "").replace(/["']?\)$/, "");
      if (url !== "none") heroImageNightInput.value = url;
    }
    if (saved["--btn-style"]) btnStyleSelect.value = saved["--btn-style"];
    if (saved["--consult-popup"] === "disabled") {
      consultToggle.checked = false;
    }

    document.getElementById("saveSettings").addEventListener("click", () => {
      const heroUrl = heroImageInput.value.trim();
      const heroNightUrl = heroImageNightInput.value.trim();

      const settings = {
        "--primary-font": primaryFontSelect.value,
        "--heading-font": headingFontSelect.value,
        "--accent-color": accentColorInput.value,
        "--hero-bg-image": heroUrl ? "url('" + heroUrl + "')" : "none",
        "--hero-bg-image-night": heroNightUrl ? "url('" + heroNightUrl + "')" : "none",
        "--btn-style": btnStyleSelect.value,
        "--consult-popup": consultToggle.checked ? "enabled" : "disabled",
      };

      localStorage.setItem("siteSettings", JSON.stringify(settings));
      console.log("Site settings saved:", settings);

      const preview = document.getElementById("previewFrame");
      if (preview) preview.src = preview.src;

      showToast("Settings saved");
    });

    /* ══════════════════════════════════════════════
       Trust & Social Proof — Success Ribbon
       ══════════════════════════════════════════════ */

    (function initTrustProof() {
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem("siteSuccessRibbon") || "null"); } catch (e) {}
      var ribbon = stored || {
        enabled: true,
        phrases: [
          "Over 5,000 families reunited through our legal advocacy",
          "Recognized by the East Bay Sanctuary Covenant for pro bono excellence",
          "Serving the Bay Area and Central Valley since 2010",
          "Multilingual team fluent in Spanish, Portuguese, Nepali, and Hindi"
        ]
      };

      document.getElementById("ribbonEnabled").checked = ribbon.enabled !== false;

      // Style controls
      var fontSizeSlider = document.getElementById("ribbonFontSize");
      var fontSizeLabel = document.getElementById("ribbonFontSizeValue");
      fontSizeSlider.value = ribbon.fontSize || 13;
      fontSizeLabel.textContent = fontSizeSlider.value;
      fontSizeSlider.addEventListener("input", function() { fontSizeLabel.textContent = fontSizeSlider.value; });

      document.getElementById("ribbonBold").checked = !!ribbon.bold;
      document.getElementById("ribbonItalic").checked = !!ribbon.italic;

      var colorInput = document.getElementById("ribbonColor");
      var colorHex = document.getElementById("ribbonColorHex");
      colorInput.value = ribbon.color || "#3b82f6";
      colorHex.textContent = colorInput.value;
      colorInput.addEventListener("input", function() { colorHex.textContent = colorInput.value; });

      var bgOpacitySlider = document.getElementById("ribbonBgOpacity");
      var bgOpacityLabel = document.getElementById("ribbonBgOpacityValue");
      bgOpacitySlider.value = ribbon.bgOpacity != null ? ribbon.bgOpacity : 6;
      bgOpacityLabel.textContent = bgOpacitySlider.value;
      bgOpacitySlider.addEventListener("input", function() { bgOpacityLabel.textContent = bgOpacitySlider.value; });

      function renderPhrases() {
        var container = document.getElementById("ribbonPhrasesList");
        if (!ribbon.phrases || ribbon.phrases.length === 0) {
          container.innerHTML = '<div class="empty-state">No phrases yet. Add one below.</div>';
          return;
        }

        container.innerHTML = ribbon.phrases.map(function(phrase, idx) {
          return '<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--off-white);border-radius:var(--radius-sm)">' +
            '<span style="font-size:0.8125rem;flex:1">' + phrase.replace(/</g, '&lt;') + '</span>' +
            '<button class="btn btn-secondary" data-idx="' + idx + '" style="padding:4px 10px;font-size:0.75rem;flex-shrink:0">Remove</button>' +
          '</div>';
        }).join('');

        container.querySelectorAll("button[data-idx]").forEach(function(btn) {
          btn.addEventListener("click", function() {
            ribbon.phrases.splice(parseInt(btn.dataset.idx, 10), 1);
            renderPhrases();
          });
        });
      }

      document.getElementById("btnAddRibbonPhrase").addEventListener("click", function() {
        var input = document.getElementById("newRibbonPhrase");
        var val = input.value.trim();
        if (!val) { showToast("Enter a phrase"); return; }
        if (!ribbon.phrases) ribbon.phrases = [];
        ribbon.phrases.push(val);
        input.value = "";
        renderPhrases();
      });

      document.getElementById("newRibbonPhrase").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("btnAddRibbonPhrase").click();
        }
      });

      document.getElementById("btnSaveRibbon").addEventListener("click", function() {
        ribbon.enabled = document.getElementById("ribbonEnabled").checked;
        ribbon.fontSize = parseInt(fontSizeSlider.value, 10);
        ribbon.bold = document.getElementById("ribbonBold").checked;
        ribbon.italic = document.getElementById("ribbonItalic").checked;
        ribbon.color = colorInput.value;
        ribbon.bgOpacity = parseInt(bgOpacitySlider.value, 10);
        localStorage.setItem("siteSuccessRibbon", JSON.stringify(ribbon));
        showToast("Ribbon settings saved");
      });

      renderPhrases();
    })();

    /* ══════════════════════════════════════════════
       Homepage Layout — Dynamic Bento Tiles
       ══════════════════════════════════════════════ */

    const ICON_OPTIONS = ["scale", "shield", "users", "document"];
    const ICON_LABELS = { scale: "Scale", shield: "Shield", users: "Users", document: "Document" };
    const PREVIEW_ICON_MAP = {
      scale: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M4 7l8-4 8 4"/><path d="M1 14l3-7 3 7a4.24 4.24 0 0 1-6 0z"/><path d="M17 14l3-7 3 7a4.24 4.24 0 0 1-6 0z"/></svg>',
      shield: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
      users: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
      document: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>'
    };
    const MAX_TILES = 5;

    function getDefaultBentoTiles() {
      return [
        { id: generateId(), title: "Family Petitions", description: "", icon: "users", layout: "large", displayMode: "icon", bgImage: "", modalImage: "", fullDescription: "" },
        { id: generateId(), title: "Removal Defense", description: "", icon: "shield", layout: "medium", displayMode: "icon", bgImage: "", modalImage: "", fullDescription: "" },
        { id: generateId(), title: "Citizenship", description: "", icon: "document", layout: "small", displayMode: "icon", bgImage: "", modalImage: "", fullDescription: "" }
      ];
    }

    function loadBentoTiles() {
      const stored = localStorage.getItem("bentoTiles");
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (!Array.isArray(parsed)) {
            const arr = [];
            if (parsed.tile1) arr.push({ id: generateId(), title: parsed.tile1.title || "", description: parsed.tile1.description || "", icon: parsed.tile1.icon || "users", layout: "large", displayMode: "icon", bgImage: "" });
            if (parsed.tile2) arr.push({ id: generateId(), title: parsed.tile2.title || "", description: parsed.tile2.description || "", icon: parsed.tile2.icon || "shield", layout: "medium", displayMode: "icon", bgImage: "" });
            if (parsed.tile3) arr.push({ id: generateId(), title: parsed.tile3.title || "", description: parsed.tile3.description || "", icon: parsed.tile3.icon || "document", layout: "small", displayMode: "icon", bgImage: "" });
            return arr;
          }
          // Ensure all fields exist on migrated tiles
          return parsed.map(t => ({ displayMode: "icon", bgImage: "", modalImage: "", fullDescription: "", ...t }));
        } catch (e) {
          return getDefaultBentoTiles();
        }
      }
      return getDefaultBentoTiles();
    }

    function renderBentoEditors() {
      const tiles = loadBentoTiles();
      const container = document.getElementById("bentoTileEditors");
      const addBtn = document.getElementById("btnAddTile");
      addBtn.disabled = tiles.length >= MAX_TILES;

      if (tiles.length === 0) {
        container.innerHTML = '<div class="empty-state">No tiles yet. Click "Add Tile" to get started.</div>';
        renderBentoPreview();
        return;
      }

      container.innerHTML = tiles.map((tile, idx) => {
        const iconOptions = ICON_OPTIONS.map((ic) =>
          '<option value="' + ic + '"' + (tile.icon === ic ? ' selected' : '') + '>' + ICON_LABELS[ic] + '</option>'
        ).join('');
        const sizeOptions = ["small", "medium", "large"].map((s) =>
          '<option value="' + s + '"' + (tile.layout === s ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>'
        ).join('');
        const isIcon = tile.displayMode !== "image";
        return '<div class="tile-editor" data-tile-id="' + tile.id + '">' +
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">' +
            '<h3>Tile ' + (idx + 1) + '</h3>' +
            '<button class="btn btn-danger btn-sm btn-remove-tile">Remove</button>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Title</label>' +
            '<input type="text" class="tile-title-input" value="' + escapeHtml(tile.title || '') + '" placeholder="Tile title">' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Description</label>' +
            '<textarea class="tile-desc-input" placeholder="Tile description">' + escapeHtml(tile.description || '') + '</textarea>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Display Mode</label>' +
            '<div style="display:flex;gap:12px;margin-top:4px">' +
              '<label style="display:flex;align-items:center;gap:6px;font-size:0.875rem;font-weight:400;text-transform:none;letter-spacing:normal;cursor:pointer">' +
                '<input type="radio" name="displayMode_' + tile.id + '" value="icon" class="tile-mode-input"' + (isIcon ? ' checked' : '') + '> Use Icon' +
              '</label>' +
              '<label style="display:flex;align-items:center;gap:6px;font-size:0.875rem;font-weight:400;text-transform:none;letter-spacing:normal;cursor:pointer">' +
                '<input type="radio" name="displayMode_' + tile.id + '" value="image" class="tile-mode-input"' + (!isIcon ? ' checked' : '') + '> Use Background Image' +
              '</label>' +
            '</div>' +
          '</div>' +
          '<div class="tile-icon-group" style="' + (isIcon ? '' : 'display:none') + '">' +
            '<div class="form-group">' +
              '<label>Icon</label>' +
              '<select class="tile-icon-input">' + iconOptions + '</select>' +
            '</div>' +
          '</div>' +
          '<div class="tile-image-group" style="' + (!isIcon ? '' : 'display:none') + '">' +
            '<div class="form-group">' +
              '<label>Background Image URL <button type="button" class="browse-btn tile-browse-btn">&#128194; Browse</button></label>' +
              '<input type="text" class="tile-bgimage-input" value="' + escapeHtml(tile.bgImage || '') + '" placeholder="https://images.unsplash.com/...">' +
            '</div>' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Tile Size</label>' +
            '<select class="tile-size-input">' + sizeOptions + '</select>' +
          '</div>' +
          '<hr style="border:none;border-top:1px solid rgba(0,0,0,0.06);margin:20px 0">' +
          '<div style="margin-bottom:8px;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.08em;color:#86868b;font-weight:600">Modal Deep Dive</div>' +
          '<div class="form-group">' +
            '<label>Modal Image URL <button type="button" class="browse-btn tile-browse-btn">&#128194; Browse</button></label>' +
            '<input type="text" class="tile-modalimage-input" value="' + escapeHtml(tile.modalImage || '') + '" placeholder="https://images.unsplash.com/... (shown in detail modal)">' +
          '</div>' +
          '<div class="form-group">' +
            '<label>Full Description</label>' +
            '<textarea class="tile-fulldesc-input" rows="4" placeholder="Detailed content shown when the tile is clicked...">' + escapeHtml(tile.fullDescription || '') + '</textarea>' +
          '</div>' +
        '</div>';
      }).join('');

      // Bind remove buttons
      container.querySelectorAll(".btn-remove-tile").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tileId = btn.closest(".tile-editor").dataset.tileId;
          let tiles = loadBentoTiles();
          tiles = tiles.filter((t) => t.id !== tileId);
          localStorage.setItem("bentoTiles", JSON.stringify(tiles));
          renderBentoEditors();
          showToast("Tile removed");
        });
      });

      // Bind display mode toggles
      container.querySelectorAll(".tile-mode-input").forEach((radio) => {
        radio.addEventListener("change", () => {
          const editor = radio.closest(".tile-editor");
          const isIcon = radio.value === "icon";
          editor.querySelector(".tile-icon-group").style.display = isIcon ? "" : "none";
          editor.querySelector(".tile-image-group").style.display = isIcon ? "none" : "";
          renderBentoPreview();
        });
      });

      // Bind live preview updates on any input change
      container.querySelectorAll("input, textarea, select").forEach((el) => {
        el.addEventListener("input", () => renderBentoPreview());
        el.addEventListener("change", () => renderBentoPreview());
      });

      // Bind Browse buttons for tile image fields
      container.querySelectorAll(".tile-browse-btn").forEach(function(btn) {
        btn.addEventListener("click", function(e) {
          e.preventDefault();
          var formGroup = btn.closest(".form-group");
          var input = formGroup ? formGroup.querySelector("input[type='text']") : null;
          if (input) openMediaPicker(input);
        });
      });

      renderBentoPreview();
    }

    function collectTilesFromEditors() {
      const editors = document.querySelectorAll("#bentoTileEditors .tile-editor");
      const tiles = [];
      editors.forEach((editor) => {
        const modeRadio = editor.querySelector('.tile-mode-input:checked');
        const displayMode = modeRadio ? modeRadio.value : "icon";
        tiles.push({
          id: editor.dataset.tileId,
          title: editor.querySelector(".tile-title-input").value.trim(),
          description: editor.querySelector(".tile-desc-input").value,
          icon: editor.querySelector(".tile-icon-input").value,
          layout: editor.querySelector(".tile-size-input").value,
          displayMode: displayMode,
          bgImage: editor.querySelector(".tile-bgimage-input") ? editor.querySelector(".tile-bgimage-input").value.trim() : "",
          modalImage: editor.querySelector(".tile-modalimage-input") ? editor.querySelector(".tile-modalimage-input").value.trim() : "",
          fullDescription: editor.querySelector(".tile-fulldesc-input") ? editor.querySelector(".tile-fulldesc-input").value : ""
        });
      });
      return tiles;
    }

    function renderBentoPreview() {
      const preview = document.getElementById("bentoPreview");
      if (!preview) return;
      const tiles = collectTilesFromEditors();
      const sizeMap = { small: "span 3", medium: "span 6", large: "span 12" };
      const heightMap = { small: "100px", medium: "120px", large: "140px" };

      preview.innerHTML = tiles.map((tile) => {
        const span = sizeMap[tile.layout] || "span 1";
        const h = heightMap[tile.layout] || "120px";
        const isImage = tile.displayMode === "image" && tile.bgImage;

        if (isImage) {
          return '<div style="grid-column:' + span + ';min-height:' + h + ';border-radius:16px;overflow:hidden;position:relative;background:url(\'' + escapeHtml(tile.bgImage) + '\') center/cover">' +
            '<div style="position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(0,0,0,0.6));backdrop-filter:blur(2px);border-radius:inherit"></div>' +
            '<div style="position:relative;z-index:1;padding:16px;display:flex;flex-direction:column;justify-content:flex-end;height:100%">' +
              '<strong style="color:#fff;font-size:0.8rem">' + escapeHtml(tile.title || 'Untitled') + '</strong>' +
              (tile.description ? '<span style="color:rgba(255,255,255,0.8);font-size:0.7rem;margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">' + escapeHtml(tile.description) + '</span>' : '') +
            '</div>' +
          '</div>';
        }

        const iconSvg = PREVIEW_ICON_MAP[tile.icon] || PREVIEW_ICON_MAP.scale;
        return '<div style="grid-column:' + span + ';min-height:' + h + ';border-radius:16px;background:rgba(255,255,255,0.6);backdrop-filter:blur(12px);border:1px solid rgba(0,0,0,0.06);padding:16px;display:flex;flex-direction:column;justify-content:space-between">' +
          '<div style="color:#1d1d1f">' + iconSvg + '</div>' +
          '<div>' +
            '<strong style="font-size:0.8rem;color:#1d1d1f">' + escapeHtml(tile.title || 'Untitled') + '</strong>' +
            (tile.description ? '<p style="font-size:0.7rem;color:#86868b;margin:4px 0 0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">' + escapeHtml(tile.description) + '</p>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    }

    document.getElementById("btnAddTile").addEventListener("click", () => {
      const tiles = loadBentoTiles();
      if (tiles.length >= MAX_TILES) { showToast("Maximum of " + MAX_TILES + " tiles"); return; }
      tiles.push({ id: generateId(), title: "", description: "", icon: "scale", layout: "medium", displayMode: "icon", bgImage: "", modalImage: "", fullDescription: "" });
      localStorage.setItem("bentoTiles", JSON.stringify(tiles));
      renderBentoEditors();
      showToast("Tile added");
    });

    document.getElementById("saveBentoTiles").addEventListener("click", () => {
      const tiles = collectTilesFromEditors();
      localStorage.setItem("bentoTiles", JSON.stringify(tiles));
      console.log("Bento tiles saved:", tiles);
      showToast("Homepage layout saved");
    });

    renderBentoEditors();

    /* ══════════════════════════════════════════════
       Posts CRUD
       ══════════════════════════════════════════════ */

    function renderPostList() {
      const container = document.getElementById("postList");
      const posts = getPosts();

      if (posts.length === 0) {
        container.innerHTML = '<div class="empty-state">No posts yet. Click "Add New Post" to get started.</div>';
        return;
      }

      container.innerHTML = posts.map((p) => {
        const badges = [];
        if (p.published) {
          badges.push('<span class="badge published">Published</span>');
        } else {
          badges.push('<span class="badge draft">Draft</span>');
        }
        if (p.category) badges.push('<span class="badge category-badge">' + escapeHtml(p.category) + '</span>');
        return '<div class="page-row" data-id="' + p.id + '">' +
          '<div class="page-row-info">' +
            '<div class="page-row-title">' + escapeHtml(p.title) + '</div>' +
            '<div class="page-row-slug">' + escapeHtml(p.date || '') + '</div>' +
          '</div>' +
          '<div class="page-row-badges">' + badges.join('') + '</div>' +
          '<div class="page-row-actions">' +
            '<button class="btn btn-secondary btn-sm btn-edit-post">Edit</button>' +
            '<button class="btn btn-danger btn-sm btn-delete-post">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll(".btn-edit-post").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          editPost(id);
        });
      });

      container.querySelectorAll(".btn-delete-post").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          deletePost(id);
        });
      });
    }

    const postFormPanel = document.getElementById("postFormPanel");
    const postListPanel = document.getElementById("postListPanel");

    function showPostForm() {
      postFormPanel.classList.add("visible");
      postListPanel.style.display = "none";
    }

    function hidePostForm() {
      postFormPanel.classList.remove("visible");
      postListPanel.style.display = "";
      clearPostForm();
    }

    function clearPostForm() {
      document.getElementById("postEditId").value = "";
      document.getElementById("postTitleInput").value = "";
      document.getElementById("postSlugInput").value = "";
      document.getElementById("postDateInput").value = "";
      document.getElementById("postCategoryInput").value = "News";
      document.getElementById("postContentInput").value = "";
      document.getElementById("postPublished").checked = true;
      document.getElementById("postFormTitle").textContent = "Add New Post";
    }

    // Auto-generate slug from title
    document.getElementById("postTitleInput").addEventListener("input", (e) => {
      const slugField = document.getElementById("postSlugInput");
      const editId = document.getElementById("postEditId").value;
      if (!editId) {
        slugField.value = e.target.value
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");
      }
    });

    document.getElementById("btnAddPost").addEventListener("click", () => {
      clearPostForm();
      // Default date to today
      document.getElementById("postDateInput").value = new Date().toISOString().split("T")[0];
      showPostForm();
    });

    document.getElementById("btnCancelPost").addEventListener("click", hidePostForm);

    document.getElementById("btnSavePost").addEventListener("click", () => {
      const title = document.getElementById("postTitleInput").value.trim();
      const slug = document.getElementById("postSlugInput").value.trim()
        .toLowerCase().replace(/[^a-z0-9-]/g, "");
      const date = document.getElementById("postDateInput").value;
      const category = document.getElementById("postCategoryInput").value;
      const content = document.getElementById("postContentInput").value;
      const published = document.getElementById("postPublished").checked;
      const editId = document.getElementById("postEditId").value;

      if (!title) { showToast("Title is required"); return; }
      if (!slug) { showToast("Slug is required"); return; }

      const posts = getPosts();

      const duplicate = posts.find((p) => p.slug === slug && p.id !== editId);
      if (duplicate) { showToast("A post with this slug already exists"); return; }

      if (editId) {
        const idx = posts.findIndex((p) => p.id === editId);
        if (idx !== -1) {
          posts[idx].title = title;
          posts[idx].slug = slug;
          posts[idx].date = date;
          posts[idx].category = category;
          posts[idx].content = content;
          posts[idx].published = published;
        }
        showToast("Post updated");
      } else {
        const now = new Date();
        const dateStr = now.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        posts.push({
          id: generateId(),
          title: title,
          slug: slug,
          date: date,
          category: category,
          content: content,
          published: published,
          createdAt: dateStr
        });
        showToast("Post created");
      }

      savePosts(posts);
      hidePostForm();
      renderPostList();
      refreshDashboard();
    });

    function editPost(id) {
      const posts = getPosts();
      const post = posts.find((p) => p.id === id);
      if (!post) return;

      document.getElementById("postEditId").value = post.id;
      document.getElementById("postTitleInput").value = post.title;
      document.getElementById("postSlugInput").value = post.slug;
      document.getElementById("postDateInput").value = post.date || "";
      document.getElementById("postCategoryInput").value = post.category || "News";
      document.getElementById("postContentInput").value = post.content || "";
      document.getElementById("postPublished").checked = post.published;
      document.getElementById("postFormTitle").textContent = "Edit Post";

      showPostForm();
    }

    function deletePost(id) {
      const posts = getPosts();
      const post = posts.find((p) => p.id === id);
      if (!post) return;

      if (!confirm('Delete "' + post.title + '"? This cannot be undone.')) return;

      const updated = posts.filter((p) => p.id !== id);
      savePosts(updated);
      renderPostList();
      refreshDashboard();
      showToast("Post deleted");
    }

    /* ══════════════════════════════════════════════
       Staff CRUD
       ══════════════════════════════════════════════ */

    function renderStaffList() {
      const container = document.getElementById("staffList");
      const staff = getStaff();

      if (staff.length === 0) {
        container.innerHTML = '<div class="empty-state">No staff yet. Click "Add Staff Member" to get started.</div>';
        return;
      }

      container.innerHTML = staff.map((s) => {
        const badges = [];
        if (s.showOnWebsite !== false) {
          badges.push('<span class="badge published">Visible</span>');
        } else {
          badges.push('<span class="badge draft">Hidden</span>');
        }
        if (s.hiring) badges.push('<span class="badge published">Hiring</span>');
        badges.push('<span class="badge nav-badge">' + escapeHtml(s.office) + '</span>');
        return '<div class="page-row" data-id="' + s.id + '">' +
          '<div class="page-row-info">' +
            '<div class="page-row-title">' + escapeHtml(s.name) + '</div>' +
            '<div class="page-row-slug">' + escapeHtml(s.title) + '</div>' +
          '</div>' +
          '<div class="page-row-badges">' + badges.join('') + '</div>' +
          '<div class="page-row-actions">' +
            '<button class="btn btn-secondary btn-sm btn-edit-staff">Edit</button>' +
            '<button class="btn btn-danger btn-sm btn-delete-staff">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll(".btn-edit-staff").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          editStaffMember(id);
        });
      });

      container.querySelectorAll(".btn-delete-staff").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          deleteStaffMember(id);
        });
      });
    }

    const staffFormPanel = document.getElementById("staffFormPanel");
    const staffListPanel = document.getElementById("staffListPanel");

    function showStaffForm() {
      staffFormPanel.classList.add("visible");
      staffListPanel.style.display = "none";
    }

    function hideStaffForm() {
      staffFormPanel.classList.remove("visible");
      staffListPanel.style.display = "";
      clearStaffForm();
    }

    function clearStaffForm() {
      document.getElementById("staffEditId").value = "";
      document.getElementById("staffNameInput").value = "";
      document.getElementById("staffTitleInput").value = "";
      var officeSelect = document.getElementById("staffOfficeInput");
      if (officeSelect.options.length > 0) officeSelect.selectedIndex = 0;
      document.getElementById("staffImageInput").value = "";
      document.getElementById("staffEmailInput").value = "";
      document.getElementById("staffPhoneInput").value = "";
      document.getElementById("staffBioInput").value = "";
      document.getElementById("staffShowOnWebsite").checked = true;
      document.getElementById("staffHiring").checked = false;
      document.getElementById("staffFormTitle").textContent = "Add Staff Member";
    }

    document.getElementById("btnAddStaff").addEventListener("click", () => {
      clearStaffForm();
      showStaffForm();
    });

    document.getElementById("btnCancelStaff").addEventListener("click", hideStaffForm);

    document.getElementById("btnSaveStaff").addEventListener("click", () => {
      const name = document.getElementById("staffNameInput").value.trim();
      const title = document.getElementById("staffTitleInput").value.trim();
      const office = document.getElementById("staffOfficeInput").value;
      const imageUrl = document.getElementById("staffImageInput").value.trim();
      const email = document.getElementById("staffEmailInput").value.trim();
      const phone = document.getElementById("staffPhoneInput").value.trim();
      const bio = document.getElementById("staffBioInput").value;
      const showOnWebsite = document.getElementById("staffShowOnWebsite").checked;
      const hiring = document.getElementById("staffHiring").checked;
      const editId = document.getElementById("staffEditId").value;

      if (!name) { showToast("Name is required"); return; }
      if (!title) { showToast("Title is required"); return; }

      const staff = getStaff();

      if (editId) {
        const idx = staff.findIndex((s) => s.id === editId);
        if (idx !== -1) {
          staff[idx].name = name;
          staff[idx].title = title;
          staff[idx].office = office;
          staff[idx].imageUrl = imageUrl;
          staff[idx].email = email;
          staff[idx].phone = phone;
          staff[idx].bio = bio;
          staff[idx].showOnWebsite = showOnWebsite;
          staff[idx].hiring = hiring;
        }
        showToast("Staff member updated");
      } else {
        const now = new Date();
        const dateStr = now.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        staff.push({
          id: generateId(),
          name: name,
          title: title,
          office: office,
          imageUrl: imageUrl,
          email: email,
          phone: phone,
          bio: bio,
          showOnWebsite: showOnWebsite,
          hiring: hiring,
          createdAt: dateStr
        });
        showToast("Staff member added");
      }

      saveStaff(staff);
      hideStaffForm();
      renderStaffList();
      refreshDashboard();
    });

    function editStaffMember(id) {
      const staff = getStaff();
      const member = staff.find((s) => s.id === id);
      if (!member) return;

      document.getElementById("staffEditId").value = member.id;
      document.getElementById("staffNameInput").value = member.name;
      document.getElementById("staffTitleInput").value = member.title;
      document.getElementById("staffOfficeInput").value = member.office || "San Francisco";
      document.getElementById("staffImageInput").value = member.imageUrl || "";
      document.getElementById("staffEmailInput").value = member.email || "";
      document.getElementById("staffPhoneInput").value = member.phone || "";
      document.getElementById("staffBioInput").value = member.bio || "";
      document.getElementById("staffShowOnWebsite").checked = member.showOnWebsite !== false;
      document.getElementById("staffHiring").checked = member.hiring || false;
      document.getElementById("staffFormTitle").textContent = "Edit Staff Member";

      showStaffForm();
    }

    function deleteStaffMember(id) {
      const staff = getStaff();
      const member = staff.find((s) => s.id === id);
      if (!member) return;

      if (!confirm('Delete "' + member.name + '"? This cannot be undone.')) return;

      const updated = staff.filter((s) => s.id !== id);
      saveStaff(updated);
      renderStaffList();
      refreshDashboard();
      showToast("Staff member deleted");
    }

    /* ══════════════════════════════════════════════
       Office Locations Picklist
       ══════════════════════════════════════════════ */

    function getOfficeLocations() {
      try {
        var stored = JSON.parse(localStorage.getItem("siteOfficeLocations") || "null");
        if (stored && stored.length) return stored;
      } catch (e) {}
      return ["San Francisco", "Stockton"];
    }

    function saveOfficeLocations(data) {
      localStorage.setItem("siteOfficeLocations", JSON.stringify(data));
    }

    function populateStaffOfficeDropdown() {
      var select = document.getElementById("staffOfficeInput");
      if (!select) return;
      var currentVal = select.value;
      var locations = getOfficeLocations();
      select.innerHTML = locations.map(function(loc) {
        return '<option value="' + loc.replace(/"/g, '&quot;') + '">' + loc + '</option>';
      }).join('');
      // Restore previous selection if still valid
      if (currentVal && locations.indexOf(currentVal) !== -1) {
        select.value = currentVal;
      }
    }

    (function initOfficeLocations() {
      var locations = getOfficeLocations();

      function renderList() {
        var container = document.getElementById("officeLocationsList");
        if (!container) return;
        locations = getOfficeLocations();

        if (locations.length === 0) {
          container.innerHTML = '<div class="empty-state">No office locations. Add one below.</div>';
          return;
        }

        container.innerHTML = locations.map(function(loc, idx) {
          return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--off-white);border-radius:var(--radius-sm)">' +
            '<span style="font-size:0.875rem;font-weight:500">' + loc + '</span>' +
            '<button class="btn btn-secondary" data-idx="' + idx + '" style="padding:4px 10px;font-size:0.75rem">Remove</button>' +
          '</div>';
        }).join('');

        container.querySelectorAll("button[data-idx]").forEach(function(btn) {
          btn.addEventListener("click", function() {
            var idx = parseInt(btn.dataset.idx, 10);
            var locName = locations[idx];
            if (!confirm('Remove "' + locName + '"? Staff members assigned to this location will keep their current value.')) return;
            locations.splice(idx, 1);
            saveOfficeLocations(locations);
            renderList();
            populateStaffOfficeDropdown();
            showToast('"' + locName + '" removed');
          });
        });
      }

      document.getElementById("btnAddOfficeLocation").addEventListener("click", function() {
        var input = document.getElementById("newOfficeLocationInput");
        var name = input.value.trim();
        if (!name) { showToast("Enter a location name"); return; }

        // Check for duplicates (case-insensitive)
        var exists = locations.some(function(loc) { return loc.toLowerCase() === name.toLowerCase(); });
        if (exists) { showToast("This location already exists"); return; }

        locations.push(name);
        saveOfficeLocations(locations);
        input.value = "";
        renderList();
        populateStaffOfficeDropdown();
        showToast('"' + name + '" added');
      });

      // Enter key support
      document.getElementById("newOfficeLocationInput").addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("btnAddOfficeLocation").click();
        }
      });

      renderList();
      populateStaffOfficeDropdown();
    })();

    /* ══════════════════════════════════════════════
       Testimonials CRUD
       ══════════════════════════════════════════════ */

    function getTestimonials() {
      try { return JSON.parse(localStorage.getItem("siteTestimonials") || "[]"); }
      catch (e) { return []; }
    }

    function saveTestimonialsData(data) {
      localStorage.setItem("siteTestimonials", JSON.stringify(data));
    }

    function renderTestimonialList() {
      const container = document.getElementById("testimonialList");
      const items = getTestimonials();

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">No testimonials yet. Click "Add Testimonial" to get started.</div>';
        return;
      }

      container.innerHTML = items.map((t) => {
        const badges = [];
        if (t.active !== false) {
          badges.push('<span class="badge published">Active</span>');
        } else {
          badges.push('<span class="badge draft">Inactive</span>');
        }
        badges.push('<span class="badge nav-badge">' + escapeHtml(t.area) + '</span>');
        badges.push('<span class="badge category-badge">' + t.rating + ' ★</span>');
        return '<div class="page-row" data-id="' + t.id + '">' +
          '<div class="page-row-info">' +
            '<div class="page-row-title">' + escapeHtml(t.name) + '</div>' +
            '<div class="page-row-slug">' + escapeHtml((t.quote || '').substring(0, 60)) + (t.quote && t.quote.length > 60 ? '…' : '') + '</div>' +
          '</div>' +
          '<div class="page-row-badges">' + badges.join('') + '</div>' +
          '<div class="page-row-actions">' +
            '<button class="btn btn-secondary btn-sm btn-edit-testimonial">Edit</button>' +
            '<button class="btn btn-danger btn-sm btn-delete-testimonial">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll(".btn-edit-testimonial").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          editTestimonial(id);
        });
      });

      container.querySelectorAll(".btn-delete-testimonial").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          deleteTestimonial(id);
        });
      });
    }

    const testimonialFormPanel = document.getElementById("testimonialFormPanel");
    const testimonialListPanel = document.getElementById("testimonialListPanel");

    function showTestimonialForm() {
      testimonialFormPanel.classList.add("visible");
      testimonialListPanel.style.display = "none";
    }

    function hideTestimonialForm() {
      testimonialFormPanel.classList.remove("visible");
      testimonialListPanel.style.display = "";
      clearTestimonialForm();
    }

    function clearTestimonialForm() {
      document.getElementById("testimonialEditId").value = "";
      document.getElementById("testimonialNameInput").value = "";
      document.getElementById("testimonialAreaInput").value = "Asylum";
      document.getElementById("testimonialQuoteInput").value = "";
      document.getElementById("testimonialRatingInput").value = "5";
      document.getElementById("testimonialActive").checked = true;
      document.getElementById("testimonialFormTitle").textContent = "Add Testimonial";
    }

    document.getElementById("btnAddTestimonial").addEventListener("click", () => {
      clearTestimonialForm();
      showTestimonialForm();
    });

    document.getElementById("btnCancelTestimonial").addEventListener("click", hideTestimonialForm);

    document.getElementById("btnSaveTestimonial").addEventListener("click", () => {
      const name = document.getElementById("testimonialNameInput").value.trim();
      const area = document.getElementById("testimonialAreaInput").value;
      const quote = document.getElementById("testimonialQuoteInput").value.trim();
      const rating = parseInt(document.getElementById("testimonialRatingInput").value, 10);
      const active = document.getElementById("testimonialActive").checked;
      const editId = document.getElementById("testimonialEditId").value;

      if (!name) { showToast("Client name is required"); return; }
      if (!quote) { showToast("Quote is required"); return; }

      const items = getTestimonials();

      if (editId) {
        const idx = items.findIndex((t) => t.id === editId);
        if (idx !== -1) {
          items[idx].name = name;
          items[idx].area = area;
          items[idx].quote = quote;
          items[idx].rating = rating;
          items[idx].active = active;
        }
        showToast("Testimonial updated");
      } else {
        const now = new Date();
        const dateStr = now.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        items.push({
          id: generateId(),
          name: name,
          area: area,
          quote: quote,
          rating: rating,
          active: active,
          createdAt: dateStr
        });
        showToast("Testimonial added");
      }

      saveTestimonialsData(items);
      hideTestimonialForm();
      renderTestimonialList();
      refreshDashboard();
    });

    function editTestimonial(id) {
      const items = getTestimonials();
      const item = items.find((t) => t.id === id);
      if (!item) return;

      document.getElementById("testimonialEditId").value = item.id;
      document.getElementById("testimonialNameInput").value = item.name;
      document.getElementById("testimonialAreaInput").value = item.area || "Asylum";
      document.getElementById("testimonialQuoteInput").value = item.quote || "";
      document.getElementById("testimonialRatingInput").value = (item.rating || 5).toString();
      document.getElementById("testimonialActive").checked = item.active !== false;
      document.getElementById("testimonialFormTitle").textContent = "Edit Testimonial";

      showTestimonialForm();
    }

    function deleteTestimonial(id) {
      const items = getTestimonials();
      const item = items.find((t) => t.id === id);
      if (!item) return;

      if (!confirm('Delete testimonial from "' + item.name + '"? This cannot be undone.')) return;

      const updated = items.filter((t) => t.id !== id);
      saveTestimonialsData(updated);
      renderTestimonialList();
      refreshDashboard();
      showToast("Testimonial deleted");
    }

    renderTestimonialList();

    /* ══════════════════════════════════════════════
       Locations CRUD
       ══════════════════════════════════════════════ */

    function getLocations() {
      try { return JSON.parse(localStorage.getItem("siteLocations") || "[]"); }
      catch (e) { return []; }
    }

    function saveLocationsData(data) {
      localStorage.setItem("siteLocations", JSON.stringify(data));
    }

    function renderLocationList() {
      const container = document.getElementById("locationList");
      const items = getLocations();

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">No locations yet. Click "Add Location" to get started.</div>';
        return;
      }

      container.innerHTML = items.map((loc) => {
        return '<div class="page-row" data-id="' + loc.id + '">' +
          '<div class="page-row-info">' +
            '<div class="page-row-title">' + escapeHtml(loc.name) + '</div>' +
            '<div class="page-row-slug">' + escapeHtml(loc.address || '') + '</div>' +
          '</div>' +
          '<div class="page-row-badges">' +
            '<span class="badge nav-badge">' + escapeHtml(loc.phone || 'No phone') + '</span>' +
          '</div>' +
          '<div class="page-row-actions">' +
            '<button class="btn btn-secondary btn-sm btn-edit-location">Edit</button>' +
            '<button class="btn btn-danger btn-sm btn-delete-location">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll(".btn-edit-location").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          editLocation(id);
        });
      });

      container.querySelectorAll(".btn-delete-location").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.closest(".page-row").dataset.id;
          deleteLocation(id);
        });
      });
    }

    const locationFormPanel = document.getElementById("locationFormPanel");
    const locationListPanel = document.getElementById("locationListPanel");

    function showLocationForm() {
      locationFormPanel.classList.add("visible");
      locationListPanel.style.display = "none";
    }

    function hideLocationForm() {
      locationFormPanel.classList.remove("visible");
      locationListPanel.style.display = "";
      clearLocationForm();
    }

    function clearLocationForm() {
      document.getElementById("locationEditId").value = "";
      document.getElementById("locationNameInput").value = "";
      document.getElementById("locationTaglineInput").value = "";
      document.getElementById("locationAddressInput").value = "";
      document.getElementById("locationPhoneInput").value = "";
      document.getElementById("locationEmailInput").value = "";
      document.getElementById("locationPhotoInput").value = "";
      document.getElementById("locationPhotoNightInput").value = "";
      document.getElementById("locationParkingInput").value = "";
      document.getElementById("locationSpecialtiesInput").value = "";
      document.getElementById("locationFormTitle").textContent = "Add Location";
    }

    document.getElementById("btnAddLocation").addEventListener("click", () => {
      clearLocationForm();
      showLocationForm();
    });

    document.getElementById("btnCancelLocation").addEventListener("click", hideLocationForm);

    document.getElementById("btnSaveLocation").addEventListener("click", () => {
      const name = document.getElementById("locationNameInput").value.trim();
      const tagline = document.getElementById("locationTaglineInput").value.trim();
      const address = document.getElementById("locationAddressInput").value.trim();
      const phone = document.getElementById("locationPhoneInput").value.trim();
      const email = document.getElementById("locationEmailInput").value.trim();
      const cityPhoto = document.getElementById("locationPhotoInput").value.trim();
      const cityPhotoNight = document.getElementById("locationPhotoNightInput").value.trim();
      const parking = document.getElementById("locationParkingInput").value.trim();
      const specialties = document.getElementById("locationSpecialtiesInput").value.trim();
      const editId = document.getElementById("locationEditId").value;

      if (!name) { showToast("Office name is required"); return; }

      const items = getLocations();

      if (editId) {
        const idx = items.findIndex((l) => l.id === editId);
        if (idx !== -1) {
          items[idx].name = name;
          items[idx].tagline = tagline;
          items[idx].address = address;
          items[idx].phone = phone;
          items[idx].email = email;
          items[idx].cityPhoto = cityPhoto;
          items[idx].cityPhotoNight = cityPhotoNight;
          items[idx].parking = parking;
          items[idx].specialties = specialties;
        }
        showToast("Location updated");
      } else {
        const now = new Date();
        const dateStr = now.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        items.push({
          id: generateId(),
          name: name,
          tagline: tagline,
          address: address,
          phone: phone,
          email: email,
          cityPhoto: cityPhoto,
          cityPhotoNight: cityPhotoNight,
          parking: parking,
          specialties: specialties,
          createdAt: dateStr
        });
        showToast("Location added");
      }

      saveLocationsData(items);
      hideLocationForm();
      renderLocationList();
      refreshDashboard();
    });

    function editLocation(id) {
      const items = getLocations();
      const loc = items.find((l) => l.id === id);
      if (!loc) return;

      document.getElementById("locationEditId").value = loc.id;
      document.getElementById("locationNameInput").value = loc.name || "";
      document.getElementById("locationTaglineInput").value = loc.tagline || "";
      document.getElementById("locationAddressInput").value = loc.address || "";
      document.getElementById("locationPhoneInput").value = loc.phone || "";
      document.getElementById("locationEmailInput").value = loc.email || "";
      document.getElementById("locationPhotoInput").value = loc.cityPhoto || "";
      document.getElementById("locationPhotoNightInput").value = loc.cityPhotoNight || "";
      document.getElementById("locationParkingInput").value = loc.parking || "";
      document.getElementById("locationSpecialtiesInput").value = loc.specialties || "";
      document.getElementById("locationFormTitle").textContent = "Edit Location";

      showLocationForm();
    }

    function deleteLocation(id) {
      const items = getLocations();
      const loc = items.find((l) => l.id === id);
      if (!loc) return;

      if (!confirm('Delete "' + loc.name + '"? This cannot be undone.')) return;

      const updated = items.filter((l) => l.id !== id);
      saveLocationsData(updated);
      renderLocationList();
      refreshDashboard();
      showToast("Location deleted");
    }

    renderLocationList();

    /* ══════════════════════════════════════════════
       Media Library & GitHub Direct Uploader
       ══════════════════════════════════════════════ */

    var GH_REPO_OWNER = "jeffreypc1";
    var GH_REPO_NAME = "my-new-website";
    var GH_UPLOAD_PATH = "assets";

    function getGitHubPAT() {
      return localStorage.getItem("ghPAT") || "";
    }

    function saveGitHubPAT(pat) {
      localStorage.setItem("ghPAT", pat);
    }

    function getMediaLibrary() {
      try {
        return JSON.parse(localStorage.getItem("mediaLibrary") || "[]");
      } catch (e) {
        return [];
      }
    }

    function saveMediaLibrary(items) {
      localStorage.setItem("mediaLibrary", JSON.stringify(items));
    }

    /* ── GitHub upload via Contents API ── */

    function uploadFileToGitHub(file, pat) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function() {
          var base64 = reader.result.split(",")[1];
          var safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
          var timestamp = Date.now().toString(36);
          var filePath = GH_UPLOAD_PATH + "/" + timestamp + "_" + safeName;

          fetch("https://api.github.com/repos/" + GH_REPO_OWNER + "/" + GH_REPO_NAME + "/contents/" + filePath, {
            method: "PUT",
            headers: {
              "Authorization": "Bearer " + pat,
              "Content-Type": "application/json",
              "Accept": "application/vnd.github.v3+json"
            },
            body: JSON.stringify({
              message: "Upload " + safeName + " via Media Suite",
              content: base64
            })
          }).then(function(res) {
            if (!res.ok) {
              return res.json().then(function(err) {
                reject(new Error(err.message || "Upload failed (" + res.status + ")"));
              });
            }
            return res.json();
          }).then(function(data) {
            if (data && data.content) {
              resolve({
                url: data.content.download_url,
                path: data.content.path,
                sha: data.content.sha,
                name: safeName
              });
            }
          }).catch(reject);
        };
        reader.onerror = function() { reject(new Error("Failed to read file")); };
        reader.readAsDataURL(file);
      });
    }

    function deleteFileFromGitHub(path, sha, pat) {
      return fetch("https://api.github.com/repos/" + GH_REPO_OWNER + "/" + GH_REPO_NAME + "/contents/" + path, {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + pat,
          "Content-Type": "application/json",
          "Accept": "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
          message: "Delete " + path.split("/").pop() + " via Media Suite",
          sha: sha
        })
      }).then(function(res) {
        if (!res.ok) throw new Error("Delete failed (" + res.status + ")");
        return res.json();
      });
    }

    function fetchAssetsFromGitHub(pat) {
      return fetch("https://api.github.com/repos/" + GH_REPO_OWNER + "/" + GH_REPO_NAME + "/contents/" + GH_UPLOAD_PATH, {
        headers: {
          "Authorization": "Bearer " + pat,
          "Accept": "application/vnd.github.v3+json"
        }
      }).then(function(res) {
        if (res.status === 404) return [];
        if (!res.ok) throw new Error("Failed to list assets (" + res.status + ")");
        return res.json();
      }).then(function(files) {
        if (!Array.isArray(files)) return [];
        return files.filter(function(f) {
          return f.type === "file" && /\.(jpg|jpeg|png|gif|svg|webp|ico)$/i.test(f.name);
        }).map(function(f) {
          return { name: f.name, path: f.path, sha: f.sha, url: f.download_url, size: f.size };
        });
      });
    }

    /* ── Sync GitHub assets → Media Library ── */

    function syncGitHubToLibrary() {
      var pat = getGitHubPAT();
      if (!pat) { updateGhBadge(false); return; }
      updateGhBadge(true);

      fetchAssetsFromGitHub(pat).then(function(ghFiles) {
        var items = getMediaLibrary();
        var existingUrls = {};
        items.forEach(function(m) { existingUrls[m.url] = true; });

        var added = 0;
        ghFiles.forEach(function(f) {
          if (!existingUrls[f.url]) {
            items.push({
              id: generateId(),
              url: f.url,
              label: f.name,
              ghPath: f.path,
              ghSha: f.sha
            });
            added++;
          } else {
            // Update sha/path for existing items
            for (var i = 0; i < items.length; i++) {
              if (items[i].url === f.url) {
                items[i].ghPath = f.path;
                items[i].ghSha = f.sha;
                break;
              }
            }
          }
        });

        if (added > 0) {
          saveMediaLibrary(items);
        } else {
          saveMediaLibrary(items); // Save updated sha/path
        }
        renderMediaGrid();
      }).catch(function(err) {
        console.warn("GitHub sync:", err.message);
      });
    }

    function updateGhBadge(connected) {
      var badge = document.getElementById("ghStatusBadge");
      if (connected) {
        badge.innerHTML = '<span style="color:#34c759">&#9679;</span> Connected';
      } else {
        badge.innerHTML = '<span style="color:var(--mid-gray)">&#9679;</span> No PAT configured';
      }
    }

    /* ── Render media as grid of thumbnails ── */

    function renderMediaGrid() {
      var container = document.getElementById("mediaList");
      var items = getMediaLibrary();

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">No media yet. Upload files or click "Add Image URL" to get started.</div>';
        return;
      }

      container.innerHTML = '<div class="media-grid">' + items.map(function(item) {
        return '<div class="media-grid-item" data-id="' + escapeHtml(item.id) + '">' +
          '<img src="' + escapeHtml(item.url) + '" alt="' + escapeHtml(item.label || '') + '" onerror="this.style.display=\'none\'">' +
          '<div class="media-grid-overlay">' +
            '<div class="media-grid-label">' + escapeHtml(item.label || item.url.split("/").pop()) + '</div>' +
            '<div class="media-grid-actions">' +
              '<button class="mgrid-copy" title="Copy URL">Copy</button>' +
              '<button class="mgrid-delete" title="Delete">Del</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('') + '</div>';

      // Bind copy
      container.querySelectorAll(".mgrid-copy").forEach(function(btn) {
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          var id = btn.closest(".media-grid-item").dataset.id;
          var item = getMediaLibrary().find(function(m) { return m.id === id; });
          if (item) {
            navigator.clipboard.writeText(item.url).then(function() {
              showToast("URL copied");
            }).catch(function() { showToast("Copy failed"); });
          }
        });
      });

      // Bind delete
      container.querySelectorAll(".mgrid-delete").forEach(function(btn) {
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          var id = btn.closest(".media-grid-item").dataset.id;
          var items = getMediaLibrary();
          var item = items.find(function(m) { return m.id === id; });
          if (!item) return;

          if (!confirm("Delete this image?")) return;

          // If it's a GitHub file, delete from repo too
          var pat = getGitHubPAT();
          if (item.ghPath && item.ghSha && pat) {
            deleteFileFromGitHub(item.ghPath, item.ghSha, pat).then(function() {
              var updated = getMediaLibrary().filter(function(m) { return m.id !== id; });
              saveMediaLibrary(updated);
              renderMediaGrid();
              showToast("Deleted from GitHub & library");
            }).catch(function(err) {
              showToast("GitHub delete failed: " + err.message);
              // Still remove from library
              var updated = getMediaLibrary().filter(function(m) { return m.id !== id; });
              saveMediaLibrary(updated);
              renderMediaGrid();
            });
          } else {
            var updated = items.filter(function(m) { return m.id !== id; });
            saveMediaLibrary(updated);
            renderMediaGrid();
            showToast("Media deleted");
          }
        });
      });
    }

    /* ── Drag & Drop + File Input ── */

    var dropZone = document.getElementById("mediaDropZone");
    var fileInput = document.getElementById("mediaFileInput");
    var progressEl = document.getElementById("mediaProgress");
    var progressFill = document.getElementById("mediaProgressFill");
    var progressText = document.getElementById("mediaProgressText");

    function handleFiles(files) {
      var pat = getGitHubPAT();
      if (!pat) {
        promptForPAT(function() { handleFiles(files); });
        return;
      }

      var fileArr = Array.from(files).filter(function(f) { return f.type.startsWith("image/"); });
      if (fileArr.length === 0) { showToast("No image files selected"); return; }

      dropZone.classList.add("uploading");
      progressEl.classList.add("visible");
      progressFill.style.width = "0%";
      progressText.textContent = "Uploading 0 of " + fileArr.length + "...";

      var done = 0;
      var chain = Promise.resolve();

      fileArr.forEach(function(file) {
        chain = chain.then(function() {
          return uploadFileToGitHub(file, pat).then(function(result) {
            done++;
            progressFill.style.width = Math.round((done / fileArr.length) * 100) + "%";
            progressText.textContent = "Uploading " + done + " of " + fileArr.length + "...";

            var items = getMediaLibrary();
            items.push({
              id: generateId(),
              url: result.url,
              label: result.name,
              ghPath: result.path,
              ghSha: result.sha
            });
            saveMediaLibrary(items);
          });
        });
      });

      chain.then(function() {
        progressText.textContent = done + " file(s) uploaded!";
        setTimeout(function() {
          progressEl.classList.remove("visible");
          dropZone.classList.remove("uploading");
        }, 2000);
        renderMediaGrid();
        showToast(done + " image(s) uploaded to GitHub");
      }).catch(function(err) {
        progressText.textContent = "Error: " + err.message;
        dropZone.classList.remove("uploading");
        showToast("Upload error: " + err.message);
      });
    }

    dropZone.addEventListener("dragover", function(e) {
      e.preventDefault();
      dropZone.classList.add("drag-over");
    });
    dropZone.addEventListener("dragleave", function() {
      dropZone.classList.remove("drag-over");
    });
    dropZone.addEventListener("drop", function(e) {
      e.preventDefault();
      dropZone.classList.remove("drag-over");
      if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener("change", function() {
      if (fileInput.files.length) handleFiles(fileInput.files);
      fileInput.value = "";
    });

    /* ── GitHub PAT prompt modal ── */

    function promptForPAT(callback) {
      var existing = document.querySelector(".gh-pat-overlay");
      if (existing) existing.remove();

      var overlay = document.createElement("div");
      overlay.className = "gh-pat-overlay";
      overlay.innerHTML =
        '<div class="gh-pat-modal">' +
          '<h3>GitHub Personal Access Token</h3>' +
          '<p>To upload images directly to your repository, enter a GitHub Personal Access Token with <strong>repo</strong> scope. Your token is stored locally in this browser only.</p>' +
          '<input type="password" id="ghPatInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" value="' + escapeHtml(getGitHubPAT()) + '">' +
          '<div class="gh-pat-actions">' +
            '<button class="btn btn-secondary btn-sm" id="ghPatCancel">Cancel</button>' +
            '<button class="btn btn-primary btn-sm" id="ghPatSave">Save &amp; Continue</button>' +
          '</div>' +
        '</div>';
      document.body.appendChild(overlay);

      document.getElementById("ghPatCancel").addEventListener("click", function() { overlay.remove(); });
      document.getElementById("ghPatSave").addEventListener("click", function() {
        var val = document.getElementById("ghPatInput").value.trim();
        if (!val) { showToast("Token is required"); return; }
        saveGitHubPAT(val);
        updateGhBadge(true);
        overlay.remove();
        if (callback) callback();
      });
    }

    document.getElementById("btnGhSettings").addEventListener("click", function() {
      promptForPAT(function() { syncGitHubToLibrary(); });
    });

    /* ── Manual URL add (preserved) ── */

    var mediaForm = document.getElementById("mediaForm");

    document.getElementById("btnAddMedia").addEventListener("click", function() {
      document.getElementById("mediaUrlInput").value = "";
      document.getElementById("mediaLabelInput").value = "";
      mediaForm.classList.add("visible");
    });

    document.getElementById("btnCancelMedia").addEventListener("click", function() {
      mediaForm.classList.remove("visible");
    });

    document.getElementById("btnSaveMedia").addEventListener("click", function() {
      var url = document.getElementById("mediaUrlInput").value.trim();
      var label = document.getElementById("mediaLabelInput").value.trim();

      if (!url) { showToast("URL is required"); return; }

      var items = getMediaLibrary();
      items.push({
        id: generateId(),
        url: url,
        label: label || "Untitled"
      });
      saveMediaLibrary(items);
      mediaForm.classList.remove("visible");
      renderMediaGrid();
      showToast("Media added");
    });

    /* ── Media Picker Modal (for Browse buttons) ── */

    function openMediaPicker(targetInput) {
      var existing = document.querySelector(".media-picker-overlay");
      if (existing) existing.remove();

      var items = getMediaLibrary();
      var gridHtml = '';

      if (items.length === 0) {
        gridHtml = '<div class="media-picker-empty">No media in library. Upload images in the Media tab first.</div>';
      } else {
        gridHtml = '<div class="media-picker-grid">' + items.map(function(item) {
          return '<div class="media-picker-item" data-url="' + escapeHtml(item.url) + '">' +
            '<img src="' + escapeHtml(item.url) + '" alt="' + escapeHtml(item.label || '') + '" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22><rect fill=%22%23e8e8ed%22 width=%2280%22 height=%2280%22/><text x=%2240%22 y=%2244%22 text-anchor=%22middle%22 fill=%22%2386868b%22 font-size=%2210%22>No preview</text></svg>\'">' +
          '</div>';
        }).join('') + '</div>';
      }

      var overlay = document.createElement("div");
      overlay.className = "media-picker-overlay";
      overlay.innerHTML =
        '<div class="media-picker-modal">' +
          '<div class="media-picker-header">' +
            '<h3>Select Image</h3>' +
            '<button class="media-picker-close">&times;</button>' +
          '</div>' +
          '<div class="media-picker-body">' + gridHtml + '</div>' +
        '</div>';
      document.body.appendChild(overlay);

      // Close
      overlay.querySelector(".media-picker-close").addEventListener("click", function() { overlay.remove(); });
      overlay.addEventListener("click", function(e) { if (e.target === overlay) overlay.remove(); });

      // Select image
      overlay.querySelectorAll(".media-picker-item").forEach(function(item) {
        item.addEventListener("click", function() {
          var url = item.dataset.url;
          if (typeof targetInput === "string") {
            var el = document.getElementById(targetInput);
            if (el) el.value = url;
          } else if (targetInput && targetInput.tagName) {
            targetInput.value = url;
          }
          overlay.remove();
          showToast("Image selected");
        });
      });
    }

    /* ── Bind all Browse buttons (static ones) ── */

    document.querySelectorAll(".browse-btn[data-target]").forEach(function(btn) {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        openMediaPicker(btn.dataset.target);
      });
    });

    /* ── Init: render grid + sync GitHub ── */

    renderMediaGrid();
    syncGitHubToLibrary();

    /* ══════════════════════════════════════════════
       Business Hours
       ══════════════════════════════════════════════ */

    var BH_DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    function getBusinessHoursAdmin() {
      try { return JSON.parse(localStorage.getItem("siteBusinessHours") || "null"); }
      catch (e) { return null; }
    }

    function getDefaultBusinessHoursAdmin() {
      var schedule = {};
      BH_DAYS.forEach(function(day) {
        if (day === "Saturday" || day === "Sunday") {
          schedule[day] = { open: "", close: "", closed: true };
        } else {
          schedule[day] = { open: "09:00", close: "17:00", closed: false };
        }
      });
      return { schedule: schedule, closures: [] };
    }

    function renderHoursGrid() {
      var data = getBusinessHoursAdmin() || getDefaultBusinessHoursAdmin();
      var grid = document.getElementById("hoursGrid");
      grid.innerHTML = BH_DAYS.map(function(day) {
        var s = data.schedule[day] || { open: "09:00", close: "17:00", closed: false };
        var isChecked = s.closed ? " checked" : "";
        return '<div style="display:grid;grid-template-columns:120px 1fr 1fr auto;gap:12px;align-items:center">' +
          '<strong style="font-size:0.875rem">' + day + '</strong>' +
          '<input type="time" class="bh-open" data-day="' + day + '" value="' + (s.open || '') + '" style="padding:8px 12px;border:1px solid var(--light-gray);border-radius:var(--radius-sm);font-family:inherit;font-size:0.875rem"' + (s.closed ? ' disabled' : '') + '>' +
          '<input type="time" class="bh-close" data-day="' + day + '" value="' + (s.close || '') + '" style="padding:8px 12px;border:1px solid var(--light-gray);border-radius:var(--radius-sm);font-family:inherit;font-size:0.875rem"' + (s.closed ? ' disabled' : '') + '>' +
          '<label style="display:flex;align-items:center;gap:6px;font-size:0.8125rem;color:var(--mid-gray);cursor:pointer;white-space:nowrap"><input type="checkbox" class="bh-closed" data-day="' + day + '"' + isChecked + '> Closed</label>' +
        '</div>';
      }).join('');

      // Toggle disable on time inputs when closed is checked
      grid.querySelectorAll(".bh-closed").forEach(function(cb) {
        cb.addEventListener("change", function() {
          var day = cb.dataset.day;
          var row = cb.closest("div");
          row.querySelector(".bh-open").disabled = cb.checked;
          row.querySelector(".bh-close").disabled = cb.checked;
        });
      });
    }

    document.getElementById("btnSaveHours").addEventListener("click", function() {
      var data = getBusinessHoursAdmin() || getDefaultBusinessHoursAdmin();
      BH_DAYS.forEach(function(day) {
        var openEl = document.querySelector('.bh-open[data-day="' + day + '"]');
        var closeEl = document.querySelector('.bh-close[data-day="' + day + '"]');
        var closedEl = document.querySelector('.bh-closed[data-day="' + day + '"]');
        data.schedule[day] = {
          open: openEl.value,
          close: closeEl.value,
          closed: closedEl.checked
        };
      });
      localStorage.setItem("siteBusinessHours", JSON.stringify(data));
      showToast("Business hours saved");
    });

    function renderClosureList() {
      var data = getBusinessHoursAdmin() || getDefaultBusinessHoursAdmin();
      var container = document.getElementById("closureList");
      var closures = data.closures || [];

      if (closures.length === 0) {
        container.innerHTML = '<div class="empty-state">No special closures set.</div>';
        return;
      }

      closures.sort(function(a, b) { return a.date.localeCompare(b.date); });

      container.innerHTML = closures.map(function(c, i) {
        return '<div class="page-row" data-index="' + i + '">' +
          '<div class="page-row-info">' +
            '<div class="page-row-title">' + escapeHtml(c.label || 'Closure') + '</div>' +
            '<div class="page-row-slug">' + escapeHtml(c.date) + '</div>' +
          '</div>' +
          '<div class="page-row-actions">' +
            '<button class="btn btn-danger btn-sm btn-delete-closure">Delete</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll(".btn-delete-closure").forEach(function(btn) {
        btn.addEventListener("click", function() {
          var idx = parseInt(btn.closest(".page-row").dataset.index);
          var d = getBusinessHoursAdmin() || getDefaultBusinessHoursAdmin();
          d.closures.splice(idx, 1);
          localStorage.setItem("siteBusinessHours", JSON.stringify(d));
          renderClosureList();
          showToast("Closure removed");
        });
      });
    }

    document.getElementById("btnAddClosure").addEventListener("click", function() {
      document.getElementById("closureForm").style.display = "block";
      document.getElementById("closureDateInput").value = "";
      document.getElementById("closureLabelInput").value = "";
    });

    document.getElementById("btnCancelClosure").addEventListener("click", function() {
      document.getElementById("closureForm").style.display = "none";
    });

    document.getElementById("btnSaveClosure").addEventListener("click", function() {
      var dateVal = document.getElementById("closureDateInput").value;
      var label = document.getElementById("closureLabelInput").value.trim();
      if (!dateVal) { showToast("Please select a date"); return; }

      var data = getBusinessHoursAdmin() || getDefaultBusinessHoursAdmin();
      if (!data.closures) data.closures = [];
      data.closures.push({ date: dateVal, label: label || "Closure" });
      localStorage.setItem("siteBusinessHours", JSON.stringify(data));

      document.getElementById("closureForm").style.display = "none";
      renderClosureList();
      showToast("Closure added");
    });

    renderHoursGrid();
    renderClosureList();

    /* ══════════════════════════════════════════════
       Clock Settings
       ══════════════════════════════════════════════ */

    /* ══════════════════════════════════════════════
       Navigation & Visibility Toggles
       ══════════════════════════════════════════════ */

    (function initNavFooter() {
      // Read centralized settings (with migration fallback)
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem("siteNavFooterSettings") || "null"); } catch (e) {}

      // Migration: construct defaults from existing settings
      var toggles = null;
      try { toggles = JSON.parse(localStorage.getItem("sitePageToggles") || "null"); } catch (e) {}
      toggles = toggles || { education: true, locations: true, staff: true, testimonials: true };

      var defaults = {
        nav: {
          home:             { visible: false, label: "Home",                href: "index.html" },
          services:         { visible: true,  label: "Services",            href: "index.html#services-grid" },
          staff:            { visible: toggles.staff !== false,             label: "Staff",               href: "staff.html" },
          testimonials:     { visible: toggles.testimonials !== false,      label: "Testimonials",        href: "testimonials.html" },
          education:        { visible: toggles.education !== false,         label: "Education",           href: "education.html" },
          locations:        { visible: toggles.locations !== false,         label: "Locations",           href: "locations.html" },
          careers:          { visible: false, label: "Careers",             href: "staff.html" },
          bookConsultation: { visible: true,  label: "Book a Consultation", href: "#", isCta: true }
        },
        globe: { visible: false, position: "hero-top-right" },
        maxNavItems: toggles.maxNavItems || 5,
        mobileCollapseBreakpoint: 768,
        footer: {
          home:         { visible: true,  label: "Home",         href: "index.html" },
          services:     { visible: false, label: "Services",     href: "index.html#services-grid" },
          staff:        { visible: true,  label: "Our Team",     href: "staff.html" },
          testimonials: { visible: true,  label: "Testimonials", href: "testimonials.html" },
          education:    { visible: true,  label: "Education",    href: "education.html" },
          locations:    { visible: true,  label: "Locations",    href: "locations.html" },
          careers:      { visible: true,  label: "Careers",      href: "staff.html" }
        },
        copyright: "\u00a9 2026 O\u2019Brien Immigration Law. All rights reserved.",
        disclaimer: ""
      };

      var settings = stored || defaults;

      // Populate nav checkboxes
      document.getElementById("nfNavHome").checked = settings.nav.home && settings.nav.home.visible;
      document.getElementById("nfNavServices").checked = settings.nav.services && settings.nav.services.visible;
      document.getElementById("nfNavStaff").checked = settings.nav.staff && settings.nav.staff.visible;
      document.getElementById("nfNavTestimonials").checked = settings.nav.testimonials && settings.nav.testimonials.visible;
      document.getElementById("nfNavEducation").checked = settings.nav.education && settings.nav.education.visible;
      document.getElementById("nfNavLocations").checked = settings.nav.locations && settings.nav.locations.visible;
      document.getElementById("nfNavCareers").checked = settings.nav.careers && settings.nav.careers.visible;
      document.getElementById("nfNavPortal").checked = settings.nav.portal && settings.nav.portal.visible;
      document.getElementById("nfNavBookConsultation").checked = settings.nav.bookConsultation && settings.nav.bookConsultation.visible;

      // Max nav items slider
      var slider = document.getElementById("nfMaxNavItems");
      var sliderLabel = document.getElementById("nfMaxNavItemsValue");
      var maxNav = settings.maxNavItems || 5;
      slider.value = maxNav;
      sliderLabel.textContent = maxNav;
      slider.addEventListener("input", function() {
        sliderLabel.textContent = slider.value;
      });

      // Mobile collapse breakpoint slider
      var bpSlider = document.getElementById("nfMobileBreakpoint");
      var bpLabel = document.getElementById("nfMobileBreakpointValue");
      var bpVal = settings.mobileCollapseBreakpoint || 768;
      bpSlider.value = bpVal;
      bpLabel.textContent = bpVal;
      bpSlider.addEventListener("input", function() {
        bpLabel.textContent = bpSlider.value;
      });

      // Footer checkboxes
      document.getElementById("nfFooterHome").checked = settings.footer.home && settings.footer.home.visible;
      document.getElementById("nfFooterServices").checked = settings.footer.services && settings.footer.services.visible;
      document.getElementById("nfFooterStaff").checked = settings.footer.staff && settings.footer.staff.visible;
      document.getElementById("nfFooterTestimonials").checked = settings.footer.testimonials && settings.footer.testimonials.visible;
      document.getElementById("nfFooterEducation").checked = settings.footer.education && settings.footer.education.visible;
      document.getElementById("nfFooterLocations").checked = settings.footer.locations && settings.footer.locations.visible;
      document.getElementById("nfFooterCareers").checked = settings.footer.careers && settings.footer.careers.visible;

      // Copyright & disclaimer
      document.getElementById("nfCopyright").value = settings.copyright || "";
      document.getElementById("nfDisclaimer").value = settings.disclaimer || "";

      // Save handler
      document.getElementById("btnSaveNavFooter").addEventListener("click", function() {
        var navBase = settings.nav; // preserve hrefs and labels from existing data
        var footerBase = settings.footer;

        var data = {
          nav: {
            home:             { visible: document.getElementById("nfNavHome").checked,             label: navBase.home.label,             href: navBase.home.href },
            services:         { visible: document.getElementById("nfNavServices").checked,         label: navBase.services.label,         href: navBase.services.href },
            staff:            { visible: document.getElementById("nfNavStaff").checked,            label: navBase.staff.label,            href: navBase.staff.href },
            testimonials:     { visible: document.getElementById("nfNavTestimonials").checked,     label: navBase.testimonials.label,     href: navBase.testimonials.href },
            education:        { visible: document.getElementById("nfNavEducation").checked,        label: navBase.education.label,        href: navBase.education.href },
            locations:        { visible: document.getElementById("nfNavLocations").checked,        label: navBase.locations.label,        href: navBase.locations.href },
            careers:          { visible: document.getElementById("nfNavCareers").checked,          label: navBase.careers.label,          href: navBase.careers.href },
            portal:           { visible: document.getElementById("nfNavPortal").checked,           label: (navBase.portal && navBase.portal.label) || "Client Portal", href: (navBase.portal && navBase.portal.href) || "portal-login.html" },
            bookConsultation: { visible: document.getElementById("nfNavBookConsultation").checked, label: navBase.bookConsultation.label, href: navBase.bookConsultation.href, isCta: true }
          },
          globe: { visible: false, position: "hero-top-right" },
          maxNavItems: parseInt(slider.value, 10),
          mobileCollapseBreakpoint: parseInt(bpSlider.value, 10),
          footer: {
            home:         { visible: document.getElementById("nfFooterHome").checked,         label: footerBase.home.label,         href: footerBase.home.href },
            services:     { visible: document.getElementById("nfFooterServices").checked,     label: footerBase.services.label,     href: footerBase.services.href },
            staff:        { visible: document.getElementById("nfFooterStaff").checked,        label: footerBase.staff.label,        href: footerBase.staff.href },
            testimonials: { visible: document.getElementById("nfFooterTestimonials").checked, label: footerBase.testimonials.label, href: footerBase.testimonials.href },
            education:    { visible: document.getElementById("nfFooterEducation").checked,    label: footerBase.education.label,    href: footerBase.education.href },
            locations:    { visible: document.getElementById("nfFooterLocations").checked,    label: footerBase.locations.label,    href: footerBase.locations.href },
            careers:      { visible: document.getElementById("nfFooterCareers").checked,      label: footerBase.careers.label,      href: footerBase.careers.href }
          },
          copyright: document.getElementById("nfCopyright").value.trim(),
          disclaimer: document.getElementById("nfDisclaimer").value.trim()
        };

        localStorage.setItem("siteNavFooterSettings", JSON.stringify(data));

        // Backward-compatible write to sitePageToggles so enforcePageToggles() keeps working
        var backcompat = {
          education: data.nav.education.visible,
          locations: data.nav.locations.visible,
          staff: data.nav.staff.visible,
          testimonials: data.nav.testimonials.visible,
          maxNavItems: data.maxNavItems
        };
        localStorage.setItem("sitePageToggles", JSON.stringify(backcompat));

        showToast("Navigation & Footer settings saved");
      });
    })();

    /* ══════════════════════════════════════════════
       Contact Config
       ══════════════════════════════════════════════ */

    (function initContactConfig() {
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem("siteContactConfig") || "null"); } catch (e) {}
      var config = stored || { formspreeUrl: "https://formspree.io/f/mpqjddon" };

      document.getElementById("formspreeUrlInput").value = config.formspreeUrl || "";

      document.getElementById("btnSaveContactConfig").addEventListener("click", function() {
        var data = {
          formspreeUrl: document.getElementById("formspreeUrlInput").value.trim()
        };
        localStorage.setItem("siteContactConfig", JSON.stringify(data));
        showToast("Contact config saved");
      });

      document.getElementById("btnTestConnection").addEventListener("click", function() {
        var url = document.getElementById("formspreeUrlInput").value.trim();
        if (!url) { showToast("Enter a Formspree URL first"); return; }

        var resultEl = document.getElementById("testConnectionResult");
        resultEl.style.display = "block";
        resultEl.style.color = "var(--mid-gray)";
        resultEl.textContent = "Sending test\u2026";

        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify({
            name: "Admin Test",
            email: "test@obrien-immigration.com",
            _subject: "Test Connection from Admin Panel",
            message: "This is a test message sent from the admin panel to verify the Formspree connection is working."
          })
        }).then(function(res) {
          if (res.ok) {
            resultEl.style.color = "#34c759";
            resultEl.textContent = "\u2713 Test sent successfully! Check your email.";
          } else {
            resultEl.style.color = "#ff3b30";
            resultEl.textContent = "\u2717 Failed (HTTP " + res.status + "). Check the URL.";
          }
        }).catch(function(err) {
          resultEl.style.color = "#ff3b30";
          resultEl.textContent = "\u2717 Connection error. Check the URL.";
        });
      });
    })();

    (function initClockSettings() {
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem("siteClockSettings") || "null"); } catch (e) {}
      var settings = stored || { visible: true, position: "center", label: "San Francisco" };

      document.getElementById("clockVisibleToggle").checked = settings.visible !== false;
      document.getElementById("clockPositionSelect").value = settings.position || "center";
      document.getElementById("clockLabelInput").value = settings.label || "San Francisco";

      document.getElementById("btnSaveClockSettings").addEventListener("click", function() {
        var data = {
          visible: document.getElementById("clockVisibleToggle").checked,
          position: document.getElementById("clockPositionSelect").value,
          label: document.getElementById("clockLabelInput").value.trim() || "San Francisco"
        };
        localStorage.setItem("siteClockSettings", JSON.stringify(data));
        showToast("Clock settings saved");
      });
    })();

    /* ══════════════════════════════════════════════
       Translation Settings
       ══════════════════════════════════════════════ */

    (function initTranslationSettings() {
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem("siteTranslation") || "null"); } catch (e) {}
      var settings = stored || { disclaimer: "This translation is automated for your convenience. For legal precision, please refer to the English original." };

      document.getElementById("translationDisclaimerInput").value = settings.disclaimer || "";

      document.getElementById("btnSaveTranslation").addEventListener("click", function() {
        var data = {
          disclaimer: document.getElementById("translationDisclaimerInput").value
        };
        localStorage.setItem("siteTranslation", JSON.stringify(data));
        showToast("Translation settings saved");
      });
    })();

    /* ══════════════════════════════════════════════
       Education Logic (Path Finder) — Picklist UI
       ══════════════════════════════════════════════ */

    function getPathFinderDataAdmin() {
      try {
        var saved = JSON.parse(localStorage.getItem("sitePathFinder") || "null");
        if (saved && saved.paths) return saved;
      } catch (e) {}
      return getDefaultPathsAdmin();
    }

    function getDefaultPathsAdmin() {
      return {
        paths: [
          {
            id: "citizen", label: "A U.S. Citizen",
            goals: [
              { id: "citizen-spouse", label: "Sponsor a spouse", process: "File Form I-130 with USCIS. As an immediate relative, your spouse has no visa queue wait.", timeline: "12–18 months", cta: "Request Deep Dive" },
              { id: "citizen-parent", label: "Sponsor a parent", process: "File Form I-130. Parents of U.S. citizens are immediate relatives.", timeline: "12–18 months", cta: "Request Deep Dive" },
              { id: "citizen-fiance", label: "Apply for a fiancé(e) visa", process: "File Form I-129F with USCIS for a K-1 visa.", timeline: "8–14 months", cta: "Request Deep Dive" }
            ]
          },
          {
            id: "lpr", label: "A Lawful Permanent Resident",
            goals: [
              { id: "lpr-spouse", label: "Sponsor a spouse", process: "File Form I-130. Spouses of LPRs fall under F2A preference.", timeline: "2–3 years", cta: "Request Deep Dive" },
              { id: "lpr-naturalize", label: "Apply for U.S. citizenship", process: "File Form N-400 after 5 years as an LPR.", timeline: "8–14 months", cta: "Request Deep Dive" }
            ]
          },
          {
            id: "undocumented", label: "Undocumented / No Status",
            goals: [
              { id: "undoc-asylum", label: "Apply for asylum", process: "File Form I-589 within one year of arrival.", timeline: "6 months – 4+ years", cta: "Request Deep Dive" }
            ]
          },
          {
            id: "visa", label: "A Visa Holder",
            goals: [
              { id: "visa-greencard", label: "Adjust to permanent residence", process: "Employer files PERM, then I-140, then I-485.", timeline: "1–5+ years", cta: "Request Deep Dive" }
            ]
          }
        ]
      };
    }

    function savePathFinderDataAdmin(data) {
      localStorage.setItem("sitePathFinder", JSON.stringify(data));
    }

    var eduSelectedStatusId = null;

    /* -- SVG icons -- */
    var eduIconEdit = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
    var eduIconTrash = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';

    /* -- Render Status List -- */
    function renderEduStatusList() {
      var data = getPathFinderDataAdmin();
      var container = document.getElementById("eduStatusList");
      document.getElementById("eduStatusCount").textContent = data.paths.length;

      if (data.paths.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:20px">No status options yet.</div>';
        return;
      }

      container.innerHTML = data.paths.map(function(p) {
        var isActive = p.id === eduSelectedStatusId;
        return '<div class="edu-item' + (isActive ? '" style="border-color:#3b82f6;background:rgba(59,130,246,0.04)"' : '"') + ' data-id="' + escapeHtml(p.id) + '">' +
          '<span class="edu-item-label" style="cursor:pointer">' + escapeHtml(p.label) + '</span>' +
          '<span style="font-size:0.75rem;color:var(--mid-gray);margin-right:8px">' + p.goals.length + ' goal' + (p.goals.length !== 1 ? 's' : '') + '</span>' +
          '<div class="edu-item-actions">' +
            '<button class="edu-icon-btn edu-status-edit" title="Edit">' + eduIconEdit + '</button>' +
            '<button class="edu-icon-btn danger edu-status-delete" title="Delete">' + eduIconTrash + '</button>' +
          '</div>' +
        '</div>';
      }).join('');

      // Click label to select status and show goals
      container.querySelectorAll(".edu-item-label").forEach(function(lbl) {
        lbl.addEventListener("click", function() {
          var id = lbl.closest(".edu-item").dataset.id;
          eduSelectedStatusId = id;
          renderEduStatusList();
          renderEduGoalList();
        });
      });

      // Edit button
      container.querySelectorAll(".edu-status-edit").forEach(function(btn) {
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          var id = btn.closest(".edu-item").dataset.id;
          var data = getPathFinderDataAdmin();
          var path = data.paths.find(function(p) { return p.id === id; });
          if (!path) return;
          showStatusInlineForm(path.label, id);
        });
      });

      // Delete button
      container.querySelectorAll(".edu-status-delete").forEach(function(btn) {
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          if (!confirm("Delete this status and all its goals?")) return;
          var id = btn.closest(".edu-item").dataset.id;
          var data = getPathFinderDataAdmin();
          data.paths = data.paths.filter(function(p) { return p.id !== id; });
          savePathFinderDataAdmin(data);
          if (eduSelectedStatusId === id) eduSelectedStatusId = null;
          renderEduStatusList();
          renderEduGoalList();
          renderLogicMap();
          showToast("Status deleted");
        });
      });
    }

    /* -- Status Inline Form -- */
    function showStatusInlineForm(value, editId) {
      var formEl = document.getElementById("eduStatusInlineForm");
      formEl.style.display = "";
      formEl.innerHTML = '<div class="edu-inline-form">' +
        '<input type="text" id="eduStatusInlineInput" placeholder="Status label..." value="' + escapeHtml(value || '') + '">' +
        '<button class="btn btn-primary btn-sm" id="eduStatusInlineSave">' + (editId ? 'Update' : 'Add') + '</button>' +
        '<button class="btn btn-secondary btn-sm" id="eduStatusInlineCancel">Cancel</button>' +
      '</div>';

      document.getElementById("eduStatusInlineInput").focus();

      document.getElementById("eduStatusInlineSave").addEventListener("click", function() {
        var label = document.getElementById("eduStatusInlineInput").value.trim();
        if (!label) { showToast("Label is required"); return; }
        var data = getPathFinderDataAdmin();
        if (editId) {
          var path = data.paths.find(function(p) { return p.id === editId; });
          if (path) path.label = label;
        } else {
          data.paths.push({ id: generateId(), label: label, goals: [] });
        }
        savePathFinderDataAdmin(data);
        hideStatusInlineForm();
        renderEduStatusList();
        renderLogicMap();
        showToast(editId ? "Status updated" : "Status added");
      });

      document.getElementById("eduStatusInlineCancel").addEventListener("click", hideStatusInlineForm);
    }

    function hideStatusInlineForm() {
      var formEl = document.getElementById("eduStatusInlineForm");
      formEl.style.display = "none";
      formEl.innerHTML = "";
    }

    /* -- Add Status Button -- */
    document.getElementById("btnAddStatus").addEventListener("click", function() {
      showStatusInlineForm("", null);
    });

    /* -- Render Goal List -- */
    function renderEduGoalList() {
      var container = document.getElementById("eduGoalListNew");
      var hint = document.getElementById("eduGoalHint");
      var addBtn = document.getElementById("btnAddGoal");
      var countEl = document.getElementById("eduGoalCount");

      if (!eduSelectedStatusId) {
        container.innerHTML = '';
        hint.style.display = "";
        addBtn.style.display = "none";
        countEl.textContent = "0";
        return;
      }

      hint.style.display = "none";
      addBtn.style.display = "";

      var data = getPathFinderDataAdmin();
      var path = data.paths.find(function(p) { return p.id === eduSelectedStatusId; });
      if (!path) {
        container.innerHTML = '<div class="empty-state">Status not found.</div>';
        addBtn.style.display = "none";
        countEl.textContent = "0";
        return;
      }

      countEl.textContent = path.goals.length;

      if (path.goals.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:20px">No goals yet. Add one below.</div>';
        return;
      }

      container.innerHTML = path.goals.map(function(g) {
        return '<div class="edu-item" data-id="' + escapeHtml(g.id) + '">' +
          '<span class="edu-item-label">' + escapeHtml(g.label) + '</span>' +
          '<span style="font-size:0.75rem;color:var(--mid-gray);margin-right:8px">' + escapeHtml(g.timeline || '') + '</span>' +
          '<div class="edu-item-actions">' +
            '<button class="edu-icon-btn edu-goal-edit" title="Edit">' + eduIconEdit + '</button>' +
            '<button class="edu-icon-btn danger edu-goal-delete" title="Delete">' + eduIconTrash + '</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll(".edu-goal-edit").forEach(function(btn) {
        btn.addEventListener("click", function() {
          var gId = btn.closest(".edu-item").dataset.id;
          var g = path.goals.find(function(x) { return x.id === gId; });
          if (!g) return;
          showGoalInlineForm(g.label, gId);
        });
      });

      container.querySelectorAll(".edu-goal-delete").forEach(function(btn) {
        btn.addEventListener("click", function() {
          if (!confirm("Delete this goal?")) return;
          var gId = btn.closest(".edu-item").dataset.id;
          var data = getPathFinderDataAdmin();
          var p = data.paths.find(function(x) { return x.id === eduSelectedStatusId; });
          if (!p) return;
          p.goals = p.goals.filter(function(x) { return x.id !== gId; });
          savePathFinderDataAdmin(data);
          renderEduGoalList();
          renderLogicMap();
          showToast("Goal deleted");
        });
      });
    }

    /* -- Goal Inline Form -- */
    function showGoalInlineForm(value, editId) {
      var formEl = document.getElementById("eduGoalInlineForm");
      formEl.style.display = "";
      formEl.innerHTML = '<div class="edu-inline-form">' +
        '<input type="text" id="eduGoalInlineInput" placeholder="Goal label..." value="' + escapeHtml(value || '') + '">' +
        '<button class="btn btn-primary btn-sm" id="eduGoalInlineSave">' + (editId ? 'Update' : 'Add') + '</button>' +
        '<button class="btn btn-secondary btn-sm" id="eduGoalInlineCancel">Cancel</button>' +
      '</div>';

      document.getElementById("eduGoalInlineInput").focus();

      document.getElementById("eduGoalInlineSave").addEventListener("click", function() {
        var label = document.getElementById("eduGoalInlineInput").value.trim();
        if (!label) { showToast("Goal label is required"); return; }
        var data = getPathFinderDataAdmin();
        var path = data.paths.find(function(p) { return p.id === eduSelectedStatusId; });
        if (!path) return;

        if (editId) {
          var existing = path.goals.find(function(g) { return g.id === editId; });
          if (existing) existing.label = label;
        } else {
          path.goals.push({ id: generateId(), label: label, process: "", timeline: "", cta: "Request Deep Dive" });
        }
        savePathFinderDataAdmin(data);
        hideGoalInlineForm();
        renderEduGoalList();
        renderLogicMap();
        showToast(editId ? "Goal updated" : "Goal added");
      });

      document.getElementById("eduGoalInlineCancel").addEventListener("click", hideGoalInlineForm);
    }

    function hideGoalInlineForm() {
      var formEl = document.getElementById("eduGoalInlineForm");
      formEl.style.display = "none";
      formEl.innerHTML = "";
    }

    /* -- Add Goal Button -- */
    document.getElementById("btnAddGoal").addEventListener("click", function() {
      showGoalInlineForm("", null);
    });

    /* -- Logic Map -- */
    function renderLogicMap() {
      var data = getPathFinderDataAdmin();
      var container = document.getElementById("logicMapContainer");

      if (data.paths.length === 0) {
        container.innerHTML = '<div class="empty-state">Add statuses and goals above to build the logic map.</div>';
        return;
      }

      var html = '<div class="logic-map-grid">';
      data.paths.forEach(function(p) {
        if (p.goals.length === 0) return;
        html += '<div class="logic-map-group">';
        html += '<div class="logic-map-group-title">' + escapeHtml(p.label) + '</div>';
        p.goals.forEach(function(g) {
          html += '<div class="logic-map-goal" data-path="' + escapeHtml(p.id) + '" data-goal="' + escapeHtml(g.id) + '">';
          html += '<div class="logic-map-goal-label">' + escapeHtml(g.label) + '</div>';
          html += '<div class="logic-map-field">' +
            '<label>Process Description</label>' +
            '<textarea class="lm-process">' + escapeHtml(g.process || '') + '</textarea>' +
          '</div>';
          html += '<div class="logic-map-field"><div class="form-row">' +
            '<div><label>Timeline</label><input type="text" class="lm-timeline" value="' + escapeHtml(g.timeline || '') + '"></div>' +
            '<div><label>CTA Button Text</label><input type="text" class="lm-cta" value="' + escapeHtml(g.cta || 'Request Deep Dive') + '"></div>' +
          '</div></div>';
          html += '</div>';
        });
        html += '</div>';
      });
      html += '</div>';
      container.innerHTML = html;
    }

    /* -- Save Logic Map -- */
    document.getElementById("btnSaveLogicMap").addEventListener("click", function() {
      var data = getPathFinderDataAdmin();
      var goals = document.querySelectorAll("#logicMapContainer .logic-map-goal");
      goals.forEach(function(el) {
        var pathId = el.dataset.path;
        var goalId = el.dataset.goal;
        var path = data.paths.find(function(p) { return p.id === pathId; });
        if (!path) return;
        var goal = path.goals.find(function(g) { return g.id === goalId; });
        if (!goal) return;
        goal.process = el.querySelector(".lm-process").value.trim();
        goal.timeline = el.querySelector(".lm-timeline").value.trim();
        goal.cta = el.querySelector(".lm-cta").value.trim() || "Request Deep Dive";
      });
      savePathFinderDataAdmin(data);
      showToast("Logic map saved");
    });

    /* -- Initial Render -- */
    renderEduStatusList();
    renderEduGoalList();
    renderLogicMap();

    /* ══════════════════════════════════════════════
       Init
       ══════════════════════════════════════════════ */

    renderPageList();
    renderPostList();
    renderStaffList();
    refreshDashboard();

    /* ══════════════════════════════════════════════
       Analytics / Insights Dashboard
       ══════════════════════════════════════════════ */

    (function initInsights() {
      // Import analytics data directly from localStorage
      function getAnalyticsEvents() {
        try {
          var data = JSON.parse(localStorage.getItem("siteAnalytics") || '{"events":[]}');
          return data.events || [];
        } catch (e) { return []; }
      }

      function getDateKey(d) {
        return d.getFullYear() + "-" +
          String(d.getMonth() + 1).padStart(2, "0") + "-" +
          String(d.getDate()).padStart(2, "0");
      }

      function renderInsights() {
        var events = getAnalyticsEvents();

        // Stat counts
        var bookClicks = events.filter(function(e) { return e.type === "book_click"; }).length;
        var submissions = events.filter(function(e) { return e.type === "form_submission"; }).length;
        document.getElementById("statBookClicks").textContent = bookClicks;
        document.getElementById("statSubmissions").textContent = submissions;

        // ── Lead Velocity (last 7 days bar chart) ──
        var now = new Date();
        var days = [];
        for (var i = 6; i >= 0; i--) {
          var d = new Date(now);
          d.setDate(d.getDate() - i);
          days.push(getDateKey(d));
        }

        var dayCounts = {};
        days.forEach(function(day) { dayCounts[day] = 0; });
        events.forEach(function(ev) {
          if (ev.type === "form_submission" && dayCounts[ev.date] !== undefined) {
            dayCounts[ev.date]++;
          }
        });

        var maxCount = Math.max.apply(null, days.map(function(d) { return dayCounts[d]; }));
        if (maxCount < 1) maxCount = 1;

        var chartEl = document.getElementById("leadVelocityChart");
        chartEl.innerHTML = days.map(function(day) {
          var count = dayCounts[day];
          var pct = (count / maxCount) * 100;
          var parts = day.split("-");
          var label = parseInt(parts[1]) + "/" + parseInt(parts[2]);
          return '<div class="velocity-bar-wrap">' +
            '<div class="velocity-count">' + count + '</div>' +
            '<div class="velocity-bar" style="height:' + Math.max(pct, 2) + '%"></div>' +
            '<div class="velocity-label">' + label + '</div>' +
          '</div>';
        }).join('');

        // ── Top Interest ──
        var goalCounts = {};
        events.forEach(function(ev) {
          if (ev.type === "form_submission" && ev.meta && ev.meta.goal && ev.meta.goal !== "Choose your goal") {
            goalCounts[ev.meta.goal] = (goalCounts[ev.meta.goal] || 0) + 1;
          }
          if (ev.type === "pathfinder_choice" && ev.meta && ev.meta.step === "goal" && ev.meta.label) {
            goalCounts[ev.meta.label] = (goalCounts[ev.meta.label] || 0) + 1;
          }
        });

        var sorted = Object.keys(goalCounts).map(function(k) {
          return { goal: k, count: goalCounts[k] };
        }).sort(function(a, b) { return b.count - a.count; }).slice(0, 5);

        var listEl = document.getElementById("topInterestList");
        if (sorted.length === 0) {
          listEl.innerHTML = '<div class="empty-state">No data yet. Interactions will appear here.</div>';
        } else {
          listEl.innerHTML = sorted.map(function(item, idx) {
            return '<div class="interest-row">' +
              '<div class="interest-rank">' + (idx + 1) + '</div>' +
              '<div class="interest-label">' + escapeHtml(item.goal) + '</div>' +
              '<div class="interest-count">' + item.count + '</div>' +
            '</div>';
          }).join('');
        }

        // ── Language Pulse (pie chart via canvas) ──
        var langCounts = {};
        events.forEach(function(ev) {
          if (ev.type === "form_submission" || ev.type === "book_click") {
            var lang = ev.language || "en";
            langCounts[lang] = (langCounts[lang] || 0) + 1;
          }
        });

        var langEntries = Object.keys(langCounts).map(function(k) {
          return { lang: k, count: langCounts[k] };
        }).sort(function(a, b) { return b.count - a.count; });

        var PIE_COLORS = ["#3b82f6", "#f59e0b", "#10b981", "#ef4444", "#8b5cf6", "#ec4899", "#06b6d4", "#84cc16", "#f97316", "#6366f1"];
        var LANG_NAMES = { en: "English", es: "Español", "zh-CN": "中文", vi: "Tiếng Việt", ko: "한국어", tl: "Tagalog", ar: "العربية", fr: "Français", pt: "Português", ru: "Русский", hi: "हिन्दी" };

        var canvas = document.getElementById("langPieCanvas");
        var ctx = canvas.getContext("2d");
        var size = 160;
        var cx = size / 2, cy = size / 2, r = 65;
        ctx.clearRect(0, 0, size, size);

        var total = langEntries.reduce(function(s, e) { return s + e.count; }, 0);

        if (total === 0) {
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
          ctx.fillStyle = "#e8e8ed";
          ctx.fill();
          ctx.fillStyle = "#86868b";
          ctx.font = "12px Inter, sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("No data", cx, cy + 4);
        } else {
          var startAngle = -Math.PI / 2;
          langEntries.forEach(function(entry, idx) {
            var slice = (entry.count / total) * Math.PI * 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, r, startAngle, startAngle + slice);
            ctx.closePath();
            ctx.fillStyle = PIE_COLORS[idx % PIE_COLORS.length];
            ctx.fill();
            startAngle += slice;
          });
          // Center hole (donut)
          ctx.beginPath();
          ctx.arc(cx, cy, 38, 0, Math.PI * 2);
          ctx.fillStyle = "#fff";
          ctx.fill();
          ctx.fillStyle = "#1d1d1f";
          ctx.font = "bold 18px Inter, sans-serif";
          ctx.textAlign = "center";
          ctx.fillText(total, cx, cy + 2);
          ctx.font = "10px Inter, sans-serif";
          ctx.fillStyle = "#86868b";
          ctx.fillText("events", cx, cy + 16);
        }

        var legendEl = document.getElementById("langPieLegend");
        if (langEntries.length === 0) {
          legendEl.innerHTML = '<span style="font-size:0.8125rem;color:var(--mid-gray)">No language data</span>';
        } else {
          legendEl.innerHTML = langEntries.map(function(entry, idx) {
            var pct = total ? Math.round((entry.count / total) * 100) : 0;
            var name = LANG_NAMES[entry.lang] || entry.lang;
            return '<div class="lang-legend-row">' +
              '<div class="lang-legend-dot" style="background:' + PIE_COLORS[idx % PIE_COLORS.length] + '"></div>' +
              '<span>' + escapeHtml(name) + ' — ' + pct + '% (' + entry.count + ')</span>' +
            '</div>';
          }).join('');
        }

        // ── Regional Heatmap ──
        var regionCounts = {};
        events.forEach(function(ev) {
          if (ev.city && ev.city !== "Unknown") {
            var label = ev.city + (ev.region ? ", " + ev.region : "");
            regionCounts[label] = (regionCounts[label] || 0) + 1;
          }
        });
        var regionSorted = Object.keys(regionCounts).map(function(k) {
          return { region: k, count: regionCounts[k] };
        }).sort(function(a, b) { return b.count - a.count; }).slice(0, 10);

        var regionEl = document.getElementById("regionalHeatmap");
        if (regionSorted.length === 0) {
          regionEl.innerHTML = '<div class="empty-state">No geographic data yet. Locations will appear as visitors interact.</div>';
        } else {
          regionEl.innerHTML = regionSorted.map(function(item, idx) {
            return '<div class="interest-row">' +
              '<div class="interest-rank">' + (idx + 1) + '</div>' +
              '<div class="interest-label">' + escapeHtml(item.region) + '</div>' +
              '<div class="interest-count">' + item.count + '</div>' +
            '</div>';
          }).join('');
        }

        // ── Device Engagement (pie chart) ──
        var deviceCounts = { Mobile: 0, Desktop: 0 };
        events.forEach(function(ev) {
          if (ev.device === "Mobile") deviceCounts.Mobile++;
          else deviceCounts.Desktop++;
        });

        var deviceCanvas = document.getElementById("devicePieCanvas");
        var dCtx = deviceCanvas.getContext("2d");
        var dSize = 160;
        var dCx = dSize / 2, dCy = dSize / 2, dR = 65;
        dCtx.clearRect(0, 0, dSize, dSize);

        var dTotal = deviceCounts.Mobile + deviceCounts.Desktop;
        var DEVICE_COLORS = ["#3b82f6", "#f59e0b"];

        if (dTotal === 0) {
          dCtx.beginPath();
          dCtx.arc(dCx, dCy, dR, 0, Math.PI * 2);
          dCtx.fillStyle = "#e8e8ed";
          dCtx.fill();
          dCtx.fillStyle = "#86868b";
          dCtx.font = "12px Inter, sans-serif";
          dCtx.textAlign = "center";
          dCtx.fillText("No data", dCx, dCy + 4);
        } else {
          var deviceEntries = [
            { label: "Desktop", count: deviceCounts.Desktop },
            { label: "Mobile", count: deviceCounts.Mobile }
          ];
          var dStart = -Math.PI / 2;
          deviceEntries.forEach(function(entry, idx) {
            if (entry.count === 0) return;
            var slice = (entry.count / dTotal) * Math.PI * 2;
            dCtx.beginPath();
            dCtx.moveTo(dCx, dCy);
            dCtx.arc(dCx, dCy, dR, dStart, dStart + slice);
            dCtx.closePath();
            dCtx.fillStyle = DEVICE_COLORS[idx];
            dCtx.fill();
            dStart += slice;
          });
          // Center hole (donut)
          dCtx.beginPath();
          dCtx.arc(dCx, dCy, 38, 0, Math.PI * 2);
          dCtx.fillStyle = "#fff";
          dCtx.fill();
          dCtx.fillStyle = "#1d1d1f";
          dCtx.font = "bold 18px Inter, sans-serif";
          dCtx.textAlign = "center";
          dCtx.fillText(dTotal, dCx, dCy + 2);
          dCtx.font = "10px Inter, sans-serif";
          dCtx.fillStyle = "#86868b";
          dCtx.fillText("events", dCx, dCy + 16);
        }

        var deviceLegendEl = document.getElementById("devicePieLegend");
        var deviceItems = [
          { label: "Desktop", count: deviceCounts.Desktop, color: DEVICE_COLORS[0] },
          { label: "Mobile", count: deviceCounts.Mobile, color: DEVICE_COLORS[1] }
        ];
        deviceLegendEl.innerHTML = deviceItems.map(function(item) {
          var pct = dTotal ? Math.round((item.count / dTotal) * 100) : 0;
          return '<div class="lang-legend-row">' +
            '<div class="lang-legend-dot" style="background:' + item.color + '"></div>' +
            '<span>' + item.label + ' — ' + pct + '% (' + item.count + ')</span>' +
          '</div>';
        }).join('');
      }

      // Render on section activation
      var insightsRendered = false;
      document.querySelectorAll('.sidebar-link[data-section="analytics"]').forEach(function(link) {
        link.addEventListener("click", function() {
          renderInsights();
          insightsRendered = true;
        });
      });

      // Clear button
      document.getElementById("btnClearAnalytics").addEventListener("click", function() {
        if (confirm("Clear all analytics data? This cannot be undone.")) {
          localStorage.removeItem("siteAnalytics");
          renderInsights();
          showToast("Analytics data cleared");
        }
      });
    })();

    (function initSalesforceBox() {
      var STORAGE_KEY = "siteSalesforceBox";
      var stored = null;
      try { stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); } catch (e) {}
      var config = stored || {};

      document.getElementById("sfConsumerKey").value = config.consumerKey || "";
      document.getElementById("sfConsumerSecret").value = config.consumerSecret || "";
      document.getElementById("sfInstanceUrl").value = config.instanceUrl || "";
      document.getElementById("boxFolderId").value = config.boxFolderId || "";

      /* ── Connection Status Indicator ── */
      var statusEl = document.getElementById("sfConnectionStatus");

      function updateConnectionStatus(state) {
        // state: "disconnected" | "checking" | "connected"
        if (state === "connected") {
          statusEl.innerHTML = '<span style="color:#00b894">&#9679;</span> Connected';
        } else if (state === "checking") {
          statusEl.innerHTML = '<span style="color:#fdcb6e">&#9679;</span> Checking...';
        } else {
          statusEl.innerHTML = '<span style="color:#d63031">&#9679;</span> Disconnected';
        }
      }

      function allFieldsPopulated() {
        var k = document.getElementById("sfConsumerKey").value.trim();
        var s = document.getElementById("sfConsumerSecret").value.trim();
        var u = document.getElementById("sfInstanceUrl").value.trim();
        return !!(k && s && u);
      }

      // On load: check if fields populated and previously verified
      if (allFieldsPopulated() && config.connectionVerified) {
        // Auto-test: show amber then simulate verification
        updateConnectionStatus("checking");
        setTimeout(function() {
          updateConnectionStatus("connected");
        }, 800);
      } else if (!allFieldsPopulated()) {
        updateConnectionStatus("disconnected");
      }

      document.getElementById("btnSaveSalesforceBox").addEventListener("click", function() {
        var data = {
          consumerKey: document.getElementById("sfConsumerKey").value.trim(),
          consumerSecret: document.getElementById("sfConsumerSecret").value.trim(),
          instanceUrl: document.getElementById("sfInstanceUrl").value.trim(),
          boxFolderId: document.getElementById("boxFolderId").value.trim()
        };
        // Clear connectionVerified if any required field is empty
        if (!data.consumerKey || !data.consumerSecret || !data.instanceUrl) {
          data.connectionVerified = false;
          updateConnectionStatus("disconnected");
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        showToast("Salesforce & Box settings saved");
      });

      document.getElementById("btnTestSalesforce").addEventListener("click", function() {
        var btn = document.getElementById("btnTestSalesforce");
        var result = document.getElementById("sfTestResult");
        var instanceUrl = document.getElementById("sfInstanceUrl").value.trim();
        var consumerKey = document.getElementById("sfConsumerKey").value.trim();
        var consumerSecret = document.getElementById("sfConsumerSecret").value.trim();

        if (!instanceUrl || !consumerKey || !consumerSecret) {
          result.style.display = "block";
          result.style.color = "#d63031";
          result.textContent = "Please fill in all three Salesforce fields before testing.";
          updateConnectionStatus("disconnected");
          return;
        }

        btn.disabled = true;
        btn.textContent = "Testing...";
        result.style.display = "block";
        result.style.color = "var(--mid-gray)";
        result.textContent = "Connecting to " + instanceUrl + "...";
        updateConnectionStatus("checking");

        setTimeout(function() {
          btn.disabled = false;
          btn.textContent = "Test Connection";
          // Simulate success (no real backend to proxy OAuth)
          result.style.color = "#00b894";
          result.textContent = "Connection simulated successfully. In production, this will verify OAuth credentials against your Salesforce org.";
          updateConnectionStatus("connected");

          // Persist connectionVerified flag
          var data = {
            consumerKey: document.getElementById("sfConsumerKey").value.trim(),
            consumerSecret: document.getElementById("sfConsumerSecret").value.trim(),
            instanceUrl: document.getElementById("sfInstanceUrl").value.trim(),
            boxFolderId: document.getElementById("boxFolderId").value.trim(),
            connectionVerified: true
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          showToast("Salesforce connection test complete");
        }, 1500);
      });
    })();
  </script>
</body>
</html>
